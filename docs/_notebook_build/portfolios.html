
<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Portfolio Construction &#8212; Financial Time Series Forecasting Repository</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  <!--
    this give us a css class that will be invisible only if js is disabled
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/sphinx-book-theme.css?v=a3416100" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css?v=be8a1c11" />
    <link rel="stylesheet" type="text/css" href="../_static/custom.css?v=37919675" />
  
  <!-- So that users can add custom icons -->
  <script src="../_static/scripts/fontawesome.js?digest=8878045cc6db502f8baf"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf" />

    <script src="../_static/documentation_options.js?v=e1a75a79"></script>
    <script src="../_static/doctools.js?v=9bcbadda"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = '_notebook_build/portfolios';</script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="He, Kelly, Manela (HKM) Test Portfolios: Options" href="../spx_options_description.html" />
    <link rel="prev" title="OptionsFilters Summary" href="combined_filters.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  <meta name="docsearch:version" content="" />
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../_static/logo.png" class="logo__image only-light" alt="Financial Time Series Forecasting Repository - Home"/>
    <img src="../_static/logo.png" class="logo__image only-dark pst-js-only" alt="Financial Time Series Forecasting Repository - Home"/>
  
  
</a></div>
        <div class="sidebar-primary-item">

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../index.html">
                    Financial Time Series Forecasting Repository (FTSFR)
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">📚 Documentation</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../data_sources_and_modules.html">Data Sources and Data Sets</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ftsfr_datasets_info.html">FTSFR Datasets Info</a></li>
<li class="toctree-l1"><a class="reference internal" href="../data_glimpses.html">Data Glimpses Report</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">📊 Data Cleaning Procedure Summaries</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="summary_cds_bond_basis_ipynb.html">Cleaning Summary: CDS Bond Basis</a></li>




<li class="toctree-l1"><a class="reference internal" href="summary_cds_returns_ipynb.html">Cleaning Summary: CDS Returns</a></li>
<li class="toctree-l1"><a class="reference internal" href="summary_cip_ipynb.html">Cleaning Summary: Covered Interest Parity (CIP) Arbitrage Spreads</a></li>
<li class="toctree-l1"><a class="reference internal" href="summary_corp_bond_returns_ipynb.html">Cleaning Summary: Corporate Bond Returns</a></li>
<li class="toctree-l1 current active has-children"><a class="reference internal" href="../cleaning_options.html">Cleaning Summary: Options Data</a><details open="open"><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="combined_filters.html">OptionsFilters Summary</a></li>

<li class="toctree-l2 current active"><a class="current reference internal" href="#">Portfolio Construction</a></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="../spx_options_description.html">He, Kelly, Manela (HKM) Test Portfolios: Options</a></li>
<li class="toctree-l1"><a class="reference internal" href="summary_treasury_bond_returns_ipynb.html">Cleaning Summary: Treasury Bond Returns</a></li>

</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">🔧 Development</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../myst_markdown_demos.html">MyST Markdown Demos 💡</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
      <div class="sidebar-primary-item">
<div id="ethical-ad-placement"
      class="flat"
      data-ea-publisher="readthedocs"
      data-ea-type="readthedocs-sidebar"
      data-ea-manual="true">
</div></div>
  </div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/jmbejara/ftsfr" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/jmbejara/ftsfr/issues/new?title=Issue%20on%20page%20%2F_notebook_build/portfolios.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/_notebook_build/portfolios.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button>


<button class="btn btn-sm pst-navbar-icon search-button search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
</button>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Portfolio Construction</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#imports">Imports</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#functions">Functions</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#execution">Execution</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#construction-of-monthly-leverage-adjusted-portfolio-returns-in-cjs">Construction of Monthly Leverage-Adjusted Portfolio Returns in CJS</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#mathematical-details-of-portfolio-construction">Mathematical Details of Portfolio Construction</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#gaussian-kernel-weighting">1. Gaussian Kernel Weighting</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#option-elasticity">2. Option Elasticity</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#arithmetic-return-of-option-i">3. Arithmetic Return of Option <span class="math notranslate nohighlight">\(i\)</span></a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#leverage-adjusted-portfolio-construction">4. Leverage-Adjusted Portfolio Construction</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#implementation">Implementation</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#build-the-ftsfa-id-for-each-portfolio">1. Build the FTSFA ID for each portfolio</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#calculate-option-elasticity-and-daily-kernel-weighting-for-candidate-options-for-each-portfolio">2. Calculate option elasticity and daily kernel weighting for candidate options for each portfolio.</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#remove-options-from-the-portfolio-with-weights-lower-than-1">3. Remove options from the portfolio with weights lower than 1%</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#calculate-the-daily-arithmetic-return-and-the-leverage-adjusted-return-of-each-portfolio">4. Calculate the daily arithmetic return and the leverage-adjusted return of each portfolio.</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#to-be-implemented-filling-nans">5. (to be implemented) Filling NaNs</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#compound-daily-portfolio-returns-to-monthly-final-54-portfolios-in-cjs">6. Compound Daily Portfolio Returns to Monthly (final 54 portfolios in CJS)</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#construction-of-18-portfolio-return-series-in-he-kelly-manela-hkm-2017">Construction of 18 Portfolio Return Series in He, Kelly, Manela (HKM 2017)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#data-discussion">Data Discussion</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#tests-for-normality-of-returns">Tests for Normality of Returns</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#testing-nan-filling-logic">Testing NaN-filling logic</a></li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="portfolio-construction">
<h1>Portfolio Construction<a class="headerlink" href="#portfolio-construction" title="Link to this heading">#</a></h1>
<section id="imports">
<h2>Imports<a class="headerlink" href="#imports" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">seaborn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sns</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">date</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>

<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;../&quot;</span><span class="p">)</span>


<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">settings</span><span class="w"> </span><span class="kn">import</span> <span class="n">config</span>


<span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.stats</span><span class="w"> </span><span class="kn">import</span> <span class="n">norm</span><span class="p">,</span> <span class="n">stats</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">scipy</span><span class="w"> </span><span class="kn">import</span> <span class="n">stats</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">scipy.stats</span><span class="w"> </span><span class="kn">import</span> <span class="n">shapiro</span><span class="p">,</span> <span class="n">jarque_bera</span><span class="p">,</span> <span class="n">normaltest</span><span class="p">,</span> <span class="n">skew</span><span class="p">,</span> <span class="n">kurtosis</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">plotly.io</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pio</span>

<span class="n">pio</span><span class="o">.</span><span class="n">templates</span><span class="o">.</span><span class="n">default</span> <span class="o">=</span> <span class="s2">&quot;plotly_white&quot;</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">OUTPUT_DIR</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">config</span><span class="p">(</span><span class="s2">&quot;OUTPUT_DIR&quot;</span><span class="p">))</span>
<span class="n">DATA_DIR</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">config</span><span class="p">(</span><span class="s2">&quot;DATA_DIR&quot;</span><span class="p">))</span>
<span class="n">DATA_DIR</span> <span class="o">=</span> <span class="n">DATA_DIR</span> <span class="o">/</span> <span class="s2">&quot;options&quot;</span>
<span class="n">WRDS_USERNAME</span> <span class="o">=</span> <span class="n">config</span><span class="p">(</span><span class="s2">&quot;WRDS_USERNAME&quot;</span><span class="p">)</span>

<span class="n">START_DATE_01</span> <span class="o">=</span> <span class="n">date</span><span class="p">(</span><span class="mi">1996</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">END_DATE_01</span> <span class="o">=</span> <span class="n">date</span><span class="p">(</span><span class="mi">2012</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">31</span><span class="p">)</span>

<span class="n">START_DATE_02</span> <span class="o">=</span> <span class="n">date</span><span class="p">(</span><span class="mi">2012</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">END_DATE_02</span> <span class="o">=</span> <span class="n">date</span><span class="p">(</span><span class="mi">2019</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">31</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">DATE_RANGE</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="n">START_DATE_01</span><span class="p">)</span><span class="si">:</span><span class="s2">%Y-%m</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="n">END_DATE_02</span><span class="p">)</span><span class="si">:</span><span class="s2">%Y-%m</span><span class="si">}</span><span class="s2">&quot;</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="functions">
<h2>Functions<a class="headerlink" href="#functions" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># --- Black-Scholes elasticity ---</span>
<span class="k">def</span><span class="w"> </span><span class="nf">bs_elasticity</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">option_type</span><span class="o">=</span><span class="s2">&quot;call&quot;</span><span class="p">):</span>
    <span class="n">d1</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">S</span> <span class="o">/</span> <span class="n">K</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">r</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">sigma</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">T</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">sigma</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">T</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">option_type</span> <span class="o">==</span> <span class="s2">&quot;call&quot;</span><span class="p">:</span>
        <span class="n">price</span> <span class="o">=</span> <span class="n">S</span> <span class="o">*</span> <span class="n">norm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">d1</span><span class="p">)</span> <span class="o">-</span> <span class="n">K</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">r</span> <span class="o">*</span> <span class="n">T</span><span class="p">)</span> <span class="o">*</span> <span class="n">norm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span>
            <span class="n">d1</span> <span class="o">-</span> <span class="n">sigma</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">T</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="n">norm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">d1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">price</span> <span class="o">=</span> <span class="n">K</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">r</span> <span class="o">*</span> <span class="n">T</span><span class="p">)</span> <span class="o">*</span> <span class="n">norm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="o">-</span><span class="n">d1</span> <span class="o">+</span> <span class="n">sigma</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">T</span><span class="p">))</span> <span class="o">-</span> <span class="n">S</span> <span class="o">*</span> <span class="n">norm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span>
            <span class="o">-</span><span class="n">d1</span>
        <span class="p">)</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="o">-</span><span class="n">norm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="o">-</span><span class="n">d1</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">delta</span> <span class="o">*</span> <span class="n">S</span> <span class="o">/</span> <span class="n">price</span><span class="p">),</span> <span class="n">price</span>


<span class="c1"># Gaussian kernel function</span>
<span class="k">def</span><span class="w"> </span><span class="nf">kernel_weights</span><span class="p">(</span><span class="n">m_grid</span><span class="p">,</span> <span class="n">ttm_grid</span><span class="p">,</span> <span class="n">k_s</span><span class="p">,</span> <span class="n">ttm</span><span class="p">,</span> <span class="n">bw_m</span><span class="o">=</span><span class="mf">0.0125</span><span class="p">,</span> <span class="n">bw_t</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
    <span class="n">m_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">m_grid</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">ttm_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">ttm_grid</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">m_grid</span> <span class="o">-</span> <span class="n">k_s</span><span class="p">)</span> <span class="o">/</span> <span class="n">bw_m</span>
    <span class="n">y</span> <span class="o">=</span> <span class="p">(</span><span class="n">ttm_grid</span> <span class="o">-</span> <span class="n">ttm</span><span class="p">)</span> <span class="o">/</span> <span class="n">bw_t</span>
    <span class="n">dist_sq</span> <span class="o">=</span> <span class="n">x</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">y</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">dist_sq</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">weights</span> <span class="o">/</span> <span class="n">weights</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="k">if</span> <span class="n">weights</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span>


<span class="c1"># --- Construct a single day portfolio ---</span>
<span class="k">def</span><span class="w"> </span><span class="nf">construct_portfolio</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">k_s_target</span><span class="p">,</span> <span class="n">ttm_target</span><span class="p">,</span> <span class="n">option_type</span><span class="o">=</span><span class="s2">&quot;call&quot;</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="mf">0.01</span><span class="p">):</span>
    <span class="n">subset</span> <span class="o">=</span> <span class="n">data</span><span class="p">[(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;option_type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">option_type</span><span class="p">)]</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="n">kernel_weights</span><span class="p">(</span><span class="n">subset</span><span class="p">[</span><span class="s2">&quot;moneyness&quot;</span><span class="p">],</span> <span class="n">subset</span><span class="p">[</span><span class="s2">&quot;ttm&quot;</span><span class="p">],</span> <span class="n">k_s_target</span><span class="p">,</span> <span class="n">ttm_target</span><span class="p">)</span>
    <span class="n">subset</span> <span class="o">=</span> <span class="n">subset</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">weight</span><span class="o">=</span><span class="n">weights</span><span class="p">)</span>
    <span class="n">subset</span> <span class="o">=</span> <span class="n">subset</span><span class="p">[</span><span class="n">subset</span><span class="p">[</span><span class="s2">&quot;weight&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.01</span><span class="p">]</span>
    <span class="n">subset</span><span class="p">[</span><span class="s2">&quot;weight&quot;</span><span class="p">]</span> <span class="o">/=</span> <span class="n">subset</span><span class="p">[</span><span class="s2">&quot;weight&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

    <span class="c1"># Leverage-adjusted returns</span>
    <span class="n">elast</span><span class="p">,</span> <span class="n">price</span> <span class="o">=</span> <span class="n">bs_elasticity</span><span class="p">(</span>
        <span class="n">S</span><span class="o">=</span><span class="n">subset</span><span class="p">[</span><span class="s2">&quot;underlying&quot;</span><span class="p">],</span>
        <span class="n">K</span><span class="o">=</span><span class="n">subset</span><span class="p">[</span><span class="s2">&quot;strike&quot;</span><span class="p">],</span>
        <span class="n">T</span><span class="o">=</span><span class="n">subset</span><span class="p">[</span><span class="s2">&quot;ttm&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">365</span><span class="p">,</span>
        <span class="n">r</span><span class="o">=</span><span class="n">r</span><span class="p">,</span>
        <span class="n">sigma</span><span class="o">=</span><span class="n">subset</span><span class="p">[</span><span class="s2">&quot;iv&quot;</span><span class="p">],</span>
        <span class="n">option_type</span><span class="o">=</span><span class="n">option_type</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">subset</span><span class="p">[</span><span class="s2">&quot;leverage_return&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">subset</span><span class="p">[</span><span class="s2">&quot;daily_return&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">elast</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">subset</span><span class="p">[</span><span class="s2">&quot;leverage_return&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">subset</span><span class="p">[</span><span class="s2">&quot;weight&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>


<span class="c1"># --- Main Loop (simplified) ---</span>
<span class="k">def</span><span class="w"> </span><span class="nf">build_portfolios</span><span class="p">(</span><span class="n">option_data</span><span class="p">,</span> <span class="n">m_grid</span><span class="p">,</span> <span class="n">ttm_grid</span><span class="p">,</span> <span class="n">option_types</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;call&quot;</span><span class="p">,</span> <span class="s2">&quot;put&quot;</span><span class="p">]):</span>
    <span class="n">portfolios</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">opt_type</span> <span class="ow">in</span> <span class="n">option_types</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">k_s</span> <span class="ow">in</span> <span class="n">m_grid</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">ttm</span> <span class="ow">in</span> <span class="n">ttm_grid</span><span class="p">:</span>
                <span class="n">ret</span> <span class="o">=</span> <span class="n">construct_portfolio</span><span class="p">(</span><span class="n">option_data</span><span class="p">,</span> <span class="n">k_s</span><span class="p">,</span> <span class="n">ttm</span><span class="p">,</span> <span class="n">option_type</span><span class="o">=</span><span class="n">opt_type</span><span class="p">)</span>
                <span class="n">portfolios</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="n">opt_type</span><span class="p">,</span> <span class="s2">&quot;moneyness&quot;</span><span class="p">:</span> <span class="n">k_s</span><span class="p">,</span> <span class="s2">&quot;ttm&quot;</span><span class="p">:</span> <span class="n">ttm</span><span class="p">,</span> <span class="s2">&quot;return&quot;</span><span class="p">:</span> <span class="n">ret</span><span class="p">}</span>
                <span class="p">)</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">portfolios</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">calc_kernel_weights</span><span class="p">(</span><span class="n">spx_mod</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate kernel weights for each option in the SPX dataset based on moneyness and maturity targets.</span>
<span class="sd">    This function iterates through predefined moneyness and maturity targets, applies kernel weights to candidate options.&quot;&quot;&quot;</span>

    <span class="c1"># Define moneyness and maturity targets from the paper</span>
    <span class="n">moneyness_targets</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.90</span><span class="p">,</span> <span class="mf">0.925</span><span class="p">,</span> <span class="mf">0.950</span><span class="p">,</span> <span class="mf">0.975</span><span class="p">,</span> <span class="mf">1.000</span><span class="p">,</span> <span class="mf">1.025</span><span class="p">,</span> <span class="mf">1.050</span><span class="p">,</span> <span class="mf">1.075</span><span class="p">,</span> <span class="mf">1.100</span><span class="p">]</span>
    <span class="n">maturity_targets</span> <span class="o">=</span> <span class="p">[</span><span class="mi">30</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">90</span><span class="p">]</span>
    <span class="n">cp_flags</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;C&quot;</span><span class="p">,</span> <span class="s2">&quot;P&quot;</span><span class="p">]</span>

    <span class="c1"># Preprocess base DataFrame</span>
    <span class="n">spx_mod</span><span class="p">[</span><span class="s2">&quot;days_to_maturity_int&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spx_mod</span><span class="p">[</span><span class="s2">&quot;days_to_maturity&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">days</span>
    <span class="n">spx_mod</span> <span class="o">=</span> <span class="n">spx_mod</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    <span class="n">spx_mod</span><span class="p">[</span><span class="s2">&quot;original_index&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spx_mod</span><span class="o">.</span><span class="n">index</span>

    <span class="n">weight_results</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Iterate through each strategy target</span>
    <span class="k">for</span> <span class="n">cp_flag</span> <span class="ow">in</span> <span class="n">cp_flags</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">target_moneyness</span> <span class="ow">in</span> <span class="n">moneyness_targets</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">target_ttm</span> <span class="ow">in</span> <span class="n">maturity_targets</span><span class="p">:</span>
                <span class="c1"># Filter candidate options</span>
                <span class="n">candidate_options</span> <span class="o">=</span> <span class="n">spx_mod</span><span class="p">[</span>
                    <span class="p">(</span><span class="n">spx_mod</span><span class="p">[</span><span class="s2">&quot;cp_flag&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">cp_flag</span><span class="p">)</span>
                    <span class="o">&amp;</span> <span class="p">(</span><span class="n">spx_mod</span><span class="p">[</span><span class="s2">&quot;moneyness_id&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">target_moneyness</span><span class="p">)</span>
                    <span class="o">&amp;</span> <span class="p">(</span><span class="n">spx_mod</span><span class="p">[</span><span class="s2">&quot;maturity_id&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">target_ttm</span><span class="p">)</span>
                <span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

                <span class="k">if</span> <span class="n">candidate_options</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="n">candidate_options</span><span class="p">[</span><span class="s2">&quot;kernel_weight&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

                <span class="c1"># Apply kernel weights per date</span>
                <span class="k">for</span> <span class="n">date</span><span class="p">,</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">candidate_options</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;date&quot;</span><span class="p">):</span>
                    <span class="n">idx</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">index</span>
                    <span class="n">weights</span> <span class="o">=</span> <span class="n">kernel_weights</span><span class="p">(</span>
                        <span class="n">g</span><span class="p">[</span><span class="s2">&quot;moneyness&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
                        <span class="n">g</span><span class="p">[</span><span class="s2">&quot;days_to_maturity_int&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
                        <span class="n">k_s</span><span class="o">=</span><span class="n">target_moneyness</span><span class="p">,</span>
                        <span class="n">ttm</span><span class="o">=</span><span class="n">target_ttm</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">candidate_options</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="s2">&quot;kernel_weight&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">weights</span>

                <span class="n">weight_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">candidate_options</span><span class="p">[[</span><span class="s2">&quot;original_index&quot;</span><span class="p">,</span> <span class="s2">&quot;kernel_weight&quot;</span><span class="p">]]</span>
                <span class="p">)</span>

    <span class="c1"># Merge weights back into spx_mod</span>
    <span class="k">if</span> <span class="n">weight_results</span><span class="p">:</span>
        <span class="n">all_weights</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">weight_results</span><span class="p">)</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;original_index&quot;</span><span class="p">)</span>
        <span class="n">spx_mod</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;original_index&quot;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">spx_mod</span><span class="p">[</span><span class="s2">&quot;kernel_weight&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">all_weights</span><span class="p">[</span><span class="s2">&quot;kernel_weight&quot;</span><span class="p">]</span>
        <span class="n">spx_mod</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No matching options found for any target.&quot;</span><span class="p">)</span>

    <span class="n">spx_mod</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;original_index&quot;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">spx_mod</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">calc_option_delta_elasticity</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="n">T</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;days_to_maturity&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">days</span> <span class="o">/</span> <span class="mf">365.0</span>
    <span class="n">S</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;close&quot;</span><span class="p">]</span>
    <span class="n">K</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;strike_price&quot;</span><span class="p">]</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;tb_m3&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">100</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;IV&quot;</span><span class="p">]</span>
    <span class="n">d1</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">S</span> <span class="o">/</span> <span class="n">K</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">r</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">sigma</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">T</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">sigma</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">T</span><span class="p">))</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
        <span class="n">option_delta</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;cp_flag&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;C&quot;</span><span class="p">,</span> <span class="n">norm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">d1</span><span class="p">),</span> <span class="n">norm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">d1</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span>
        <span class="n">option_elasticity</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;option_delta&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;close&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;mid_price&quot;</span><span class="p">],</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">df</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">read_option_data</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="c1"># Example string interval: &#39;(0.9, 0.95]&#39;</span>
    <span class="c1"># Remove whitespace and parse the string into tuples</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">parse_interval_string</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
        <span class="c1"># Handle missing or malformed entries gracefully</span>
        <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">NA</span>  <span class="c1"># or np.nan</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;(&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;]&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">left</span><span class="p">,</span> <span class="n">right</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">Interval</span><span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="n">closed</span><span class="o">=</span><span class="s2">&quot;right&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">NA</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

    <span class="c1"># restore the &#39;moneyness_bin&#39; column as intervals</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;moneyness_bin&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;moneyness_bin&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">parse_interval_string</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">df</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">compute_cjs_return_leverage_investment</span><span class="p">(</span><span class="n">spx_mod</span><span class="p">):</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">spx_mod</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s2">&quot;ftfsa_id&quot;</span><span class="p">,</span> <span class="s2">&quot;date&quot;</span><span class="p">])</span>

    <span class="c1"># Lag price</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;mid_price_lag&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;ftfsa_id&quot;</span><span class="p">)[</span><span class="s2">&quot;mid_price&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Return and daily risk-free rate</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;option_return&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;mid_price&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;mid_price_lag&quot;</span><span class="p">])</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;mid_price_lag&quot;</span><span class="p">]</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;daily_rf&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;tb_m3&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">100</span> <span class="o">/</span> <span class="mi">252</span>

    <span class="c1"># Weighted dollar investment and return contribution</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;inv_weight&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;kernel_weight&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;option_elasticity&quot;</span><span class="p">]</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;inv_return&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;inv_weight&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;option_return&quot;</span><span class="p">]</span>

    <span class="c1"># Group and aggregate</span>
    <span class="n">grouped</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;date&quot;</span><span class="p">,</span> <span class="s2">&quot;ftfsa_id&quot;</span><span class="p">])</span>

    <span class="n">port</span> <span class="o">=</span> <span class="n">grouped</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span>
        <span class="n">total_inv_weight</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;inv_weight&quot;</span><span class="p">,</span> <span class="s2">&quot;sum&quot;</span><span class="p">),</span>
        <span class="n">total_inv_return</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;inv_return&quot;</span><span class="p">,</span> <span class="s2">&quot;sum&quot;</span><span class="p">),</span>
        <span class="n">daily_rf</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;daily_rf&quot;</span><span class="p">,</span> <span class="s2">&quot;first&quot;</span><span class="p">),</span>
        <span class="n">cp_flag</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;cp_flag&quot;</span><span class="p">,</span> <span class="s2">&quot;first&quot;</span><span class="p">),</span>
    <span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

    <span class="c1"># Apply CJS logic</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">adjusted_return</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;cp_flag&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;C&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span>
                <span class="n">row</span><span class="p">[</span><span class="s2">&quot;total_inv_return&quot;</span><span class="p">]</span>
                <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;total_inv_weight&quot;</span><span class="p">])</span> <span class="o">*</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;daily_rf&quot;</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;cp_flag&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;P&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span>
                <span class="o">-</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;total_inv_return&quot;</span><span class="p">]</span>
                <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;total_inv_weight&quot;</span><span class="p">])</span> <span class="o">*</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;daily_rf&quot;</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

    <span class="n">port</span><span class="p">[</span><span class="s2">&quot;portfolio_return&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">port</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">adjusted_return</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">port</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Function to compute normality metrics</span>
<span class="k">def</span><span class="w"> </span><span class="nf">normality_summary</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
    <span class="n">summary</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">series</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
        <span class="n">shapiro_p</span> <span class="o">=</span> <span class="n">shapiro</span><span class="p">(</span><span class="n">series</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">jb_stat</span><span class="p">,</span> <span class="n">jb_p</span> <span class="o">=</span> <span class="n">jarque_bera</span><span class="p">(</span><span class="n">series</span><span class="p">)</span>
        <span class="n">normaltest_p</span> <span class="o">=</span> <span class="n">normaltest</span><span class="p">(</span><span class="n">series</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">skew_val</span> <span class="o">=</span> <span class="n">skew</span><span class="p">(</span><span class="n">series</span><span class="p">)</span>
        <span class="n">kurt_val</span> <span class="o">=</span> <span class="n">kurtosis</span><span class="p">(</span><span class="n">series</span><span class="p">,</span> <span class="n">fisher</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">summary</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;Series&quot;</span><span class="p">:</span> <span class="n">col</span><span class="p">,</span>
                <span class="s2">&quot;Shapiro_p&quot;</span><span class="p">:</span> <span class="n">shapiro_p</span><span class="p">,</span>
                <span class="s2">&quot;JarqueBera_p&quot;</span><span class="p">:</span> <span class="n">jb_p</span><span class="p">,</span>
                <span class="s2">&quot;Normaltest_p&quot;</span><span class="p">:</span> <span class="n">normaltest_p</span><span class="p">,</span>
                <span class="s2">&quot;Skewness&quot;</span><span class="p">:</span> <span class="n">skew_val</span><span class="p">,</span>
                <span class="s2">&quot;Kurtosis&quot;</span><span class="p">:</span> <span class="n">kurt_val</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">summary</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="execution">
<h2>Execution<a class="headerlink" href="#execution" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># read filtered data</span>
<span class="n">source_file</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">DATA_DIR</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;spx_filtered_final_</span><span class="si">{</span><span class="n">DATE_RANGE</span><span class="si">}</span><span class="s2">.parquet&quot;</span><span class="p">)</span>
<span class="n">spx_filtered</span> <span class="o">=</span> <span class="n">read_option_data</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">source_file</span><span class="p">)</span>
<span class="n">spx_filtered</span> <span class="o">=</span> <span class="n">spx_filtered</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

<span class="c1"># create the moneyness ID from the moneyness_bin column, using the right edge of the interval</span>
<span class="n">spx_filtered</span><span class="p">[</span><span class="s2">&quot;moneyness_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spx_filtered</span><span class="p">[</span><span class="s2">&quot;moneyness_bin&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
    <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">right</span> <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">notnull</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
<span class="p">)</span>
<span class="c1"># drop any rows where moneyness_id is NaN</span>
<span class="n">spx_filtered</span> <span class="o">=</span> <span class="n">spx_filtered</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;moneyness_id&quot;</span><span class="p">])</span>

<span class="n">spx_filtered</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>date</th>
      <th>exdate</th>
      <th>moneyness</th>
      <th>secid</th>
      <th>open</th>
      <th>close</th>
      <th>cp_flag</th>
      <th>IV</th>
      <th>tb_m3</th>
      <th>volume</th>
      <th>...</th>
      <th>days_to_maturity</th>
      <th>pc_parity_int_rate</th>
      <th>intrinsic</th>
      <th>log_iv</th>
      <th>fitted_iv</th>
      <th>rel_distance_iv</th>
      <th>moneyness_bin</th>
      <th>stdev_iv_moneyness_bin</th>
      <th>is_outlier_iv</th>
      <th>moneyness_id</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1996-01-04</td>
      <td>1996-01-20</td>
      <td>0.987534</td>
      <td>108105.0</td>
      <td>621.32</td>
      <td>617.70</td>
      <td>C</td>
      <td>0.082711</td>
      <td>5.04</td>
      <td>444.0</td>
      <td>...</td>
      <td>16 days</td>
      <td>0.015898</td>
      <td>7.70</td>
      <td>-2.492403</td>
      <td>-2.377298</td>
      <td>4.841838</td>
      <td>(0.975, 1.0]</td>
      <td>3.516840</td>
      <td>False</td>
      <td>1.000</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1996-01-04</td>
      <td>1996-01-20</td>
      <td>1.019913</td>
      <td>108105.0</td>
      <td>621.32</td>
      <td>617.70</td>
      <td>C</td>
      <td>0.097356</td>
      <td>5.04</td>
      <td>4022.0</td>
      <td>...</td>
      <td>16 days</td>
      <td>0.015898</td>
      <td>0.00</td>
      <td>-2.329381</td>
      <td>-2.285771</td>
      <td>1.907866</td>
      <td>(1.0, 1.025]</td>
      <td>5.219336</td>
      <td>False</td>
      <td>1.025</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1996-01-04</td>
      <td>1996-01-20</td>
      <td>1.028007</td>
      <td>108105.0</td>
      <td>621.32</td>
      <td>617.70</td>
      <td>C</td>
      <td>0.101756</td>
      <td>5.04</td>
      <td>1627.0</td>
      <td>...</td>
      <td>16 days</td>
      <td>0.015898</td>
      <td>0.00</td>
      <td>-2.285177</td>
      <td>-2.264082</td>
      <td>0.931727</td>
      <td>(1.025, 1.05]</td>
      <td>4.396845</td>
      <td>False</td>
      <td>1.050</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1996-01-04</td>
      <td>1996-01-20</td>
      <td>1.036102</td>
      <td>108105.0</td>
      <td>621.32</td>
      <td>617.70</td>
      <td>C</td>
      <td>0.100588</td>
      <td>5.04</td>
      <td>0.0</td>
      <td>...</td>
      <td>16 days</td>
      <td>0.015898</td>
      <td>0.00</td>
      <td>-2.296722</td>
      <td>-2.242870</td>
      <td>2.401027</td>
      <td>(1.025, 1.05]</td>
      <td>4.396845</td>
      <td>False</td>
      <td>1.050</td>
    </tr>
    <tr>
      <th>4</th>
      <td>1996-01-04</td>
      <td>1996-02-17</td>
      <td>0.963251</td>
      <td>108105.0</td>
      <td>621.32</td>
      <td>617.70</td>
      <td>C</td>
      <td>0.071852</td>
      <td>5.04</td>
      <td>3.0</td>
      <td>...</td>
      <td>44 days</td>
      <td>0.014622</td>
      <td>22.70</td>
      <td>-2.633147</td>
      <td>-2.563785</td>
      <td>2.705450</td>
      <td>(0.95, 0.975]</td>
      <td>2.301503</td>
      <td>False</td>
      <td>0.975</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>3195881</th>
      <td>2019-12-31</td>
      <td>2020-06-19</td>
      <td>1.044639</td>
      <td>108105.0</td>
      <td>3215.18</td>
      <td>3230.78</td>
      <td>P</td>
      <td>0.117063</td>
      <td>1.52</td>
      <td>0.0</td>
      <td>...</td>
      <td>171 days</td>
      <td>0.014769</td>
      <td>144.22</td>
      <td>-2.145043</td>
      <td>-2.132215</td>
      <td>0.601630</td>
      <td>(1.025, 1.05]</td>
      <td>4.396845</td>
      <td>False</td>
      <td>1.050</td>
    </tr>
    <tr>
      <th>3195882</th>
      <td>2019-12-31</td>
      <td>2020-06-19</td>
      <td>1.052377</td>
      <td>108105.0</td>
      <td>3215.18</td>
      <td>3230.78</td>
      <td>P</td>
      <td>0.113900</td>
      <td>1.52</td>
      <td>0.0</td>
      <td>...</td>
      <td>171 days</td>
      <td>0.014769</td>
      <td>169.22</td>
      <td>-2.172434</td>
      <td>-2.165558</td>
      <td>0.317525</td>
      <td>(1.05, 1.075]</td>
      <td>5.236635</td>
      <td>False</td>
      <td>1.075</td>
    </tr>
    <tr>
      <th>3195883</th>
      <td>2019-12-31</td>
      <td>2020-06-19</td>
      <td>1.060116</td>
      <td>108105.0</td>
      <td>3215.18</td>
      <td>3230.78</td>
      <td>P</td>
      <td>0.110925</td>
      <td>1.52</td>
      <td>20.0</td>
      <td>...</td>
      <td>171 days</td>
      <td>0.014769</td>
      <td>194.22</td>
      <td>-2.198901</td>
      <td>-2.199596</td>
      <td>-0.031616</td>
      <td>(1.05, 1.075]</td>
      <td>5.236635</td>
      <td>False</td>
      <td>1.075</td>
    </tr>
    <tr>
      <th>3195884</th>
      <td>2019-12-31</td>
      <td>2020-06-19</td>
      <td>1.067854</td>
      <td>108105.0</td>
      <td>3215.18</td>
      <td>3230.78</td>
      <td>P</td>
      <td>0.108540</td>
      <td>1.52</td>
      <td>0.0</td>
      <td>...</td>
      <td>171 days</td>
      <td>0.014769</td>
      <td>219.22</td>
      <td>-2.220637</td>
      <td>-2.234330</td>
      <td>-0.612848</td>
      <td>(1.05, 1.075]</td>
      <td>5.236635</td>
      <td>False</td>
      <td>1.075</td>
    </tr>
    <tr>
      <th>3195885</th>
      <td>2019-12-31</td>
      <td>2020-06-19</td>
      <td>1.075592</td>
      <td>108105.0</td>
      <td>3215.18</td>
      <td>3230.78</td>
      <td>P</td>
      <td>0.106814</td>
      <td>1.52</td>
      <td>0.0</td>
      <td>...</td>
      <td>171 days</td>
      <td>0.014769</td>
      <td>244.22</td>
      <td>-2.236666</td>
      <td>-2.269758</td>
      <td>-1.457925</td>
      <td>(1.075, 1.1]</td>
      <td>5.723928</td>
      <td>False</td>
      <td>1.100</td>
    </tr>
  </tbody>
</table>
<p>2676696 rows × 26 columns</p>
</div></div></div>
</div>
<section id="construction-of-monthly-leverage-adjusted-portfolio-returns-in-cjs">
<h3>Construction of Monthly Leverage-Adjusted Portfolio Returns in CJS<a class="headerlink" href="#construction-of-monthly-leverage-adjusted-portfolio-returns-in-cjs" title="Link to this heading">#</a></h3>
<p><strong>Process</strong></p>
<p>The construction of the 27 call and 27 put portfolios in CJS is a multi-step process, with the objective of developing portfolio returns series that are stationary and only moderately skewed. Note that the discrete bucketing of moneyness and days to maturity lead to multiple candidate options for each portfolio on each trading day. These options  are given weights according to a <strong>bivariate Gaussian weighting kernel</strong> in moneyness and maturity (bandwidths: <em>0.0125 in moneyness</em> and <em>10 days to maturity</em>).</p>
<p>Each portfolio’s daily returns are initially calculated as simple arithmetic return, assuming the option is bought and sold at its bid-ask midpoint at each rebalancing. The one-day arithmetic return is then converted to a <strong>leverage-adjusted return</strong>. This procedure is achieved by calculating the one-day return of a hypothetical portfolio with <span class="math notranslate nohighlight">\(\omega_{BSM}^{-1}\)</span> dollars invested in the option, and <span class="math notranslate nohighlight">\((1 - \omega^{-1})\)</span> dollars invested in the risk-free rate, where <span class="math notranslate nohighlight">\(\omega_{BSM}\)</span> is the BSM elasticity based on the implied volatility of the option.</p>
<div class="amsmath math notranslate nohighlight" id="equation-c8361d07-649b-4b79-a78b-0ac1b474ea50">
<span class="eqno">(1)<a class="headerlink" href="#equation-c8361d07-649b-4b79-a78b-0ac1b474ea50" title="Permalink to this equation">#</a></span>\[\begin{align}
\omega_{\text{BSM, Call}} &amp;= \frac{\partial C_{\text{BSM}}}{\partial S} \cdot \frac{S}{C_{\text{BSM}}} &gt; 1 \\
\omega_{\text{BSM, Put}}  &amp;= \frac{\partial P_{\text{BSM}}}{\partial S} \cdot \frac{S}{P_{\text{BSM}}} &lt; -1
\end{align}\]</div>
<p>Each <strong>leverage-adjusted call portfolio</strong> comprises of a long position in a fraction of a call, and some investment in the risk-free rate.</p>
<p>Each <strong>leverage-adjusted put portfolio</strong> comprises of a short position in a fraction of a put, and &gt;100% investment in the risk-free rate.</p>
</section>
<section id="mathematical-details-of-portfolio-construction">
<h3>Mathematical Details of Portfolio Construction<a class="headerlink" href="#mathematical-details-of-portfolio-construction" title="Link to this heading">#</a></h3>
<p><font color="blue"><em>For clarity, we present below the mathematics behind CJS’ descriptions of the portfolio construction process. The following applies for a single trading day <span class="math notranslate nohighlight">\(t\)</span>, for a set of candidate call or put options. Portfolios in CJS are identified by 3 characteristics: option type (call or put), moneyness (9 discrete targets), and time to maturity (3 discrete targets). On any given day, it is rare to find options that exactly match the moneyness and maturity targets. Instead, there may be multiple options that are “close to” the target moneyness / maturity (each a <strong>“candidate option”</strong>). Furthermore, each candidate option has its own price and price sensitivity to changes in the underlying SPX index level. In order to arrive at a “price” for an option portfolio, CJS applies a <strong>Gaussian weighting kernel</strong> in moneyness and maturity, as described below. This kernel-weighted price across the candidate options on a given day is used as the price of the <strong>option component</strong> of the portfolio (the other component being the risk-free rate). This portfolio is leverage-adjusted using the BSM elasticity, in order to standardize the sensitivity of OTM and ITM portfolios to changes in the underlying.</em></font></p>
<section id="gaussian-kernel-weighting">
<h4>1. Gaussian Kernel Weighting<a class="headerlink" href="#gaussian-kernel-weighting" title="Link to this heading">#</a></h4>
<p>Let:</p>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\(m_{i}\)</span> = moneyness of option <span class="math notranslate nohighlight">\(i\)</span></p></li>
<li><p><span class="math notranslate nohighlight">\(\tau_{i}\)</span> = days to maturity of option <span class="math notranslate nohighlight">\(i\)</span></p></li>
<li><p><span class="math notranslate nohighlight">\(k_{s}\)</span> = target moneyness</p></li>
<li><p><span class="math notranslate nohighlight">\(\tau\)</span> = target maturity</p></li>
<li><p><span class="math notranslate nohighlight">\(h_{m}\)</span>, <span class="math notranslate nohighlight">\(h_{\tau}\)</span> = bandwidths for moneyness and maturity</p></li>
<li><p><span class="math notranslate nohighlight">\(d_{i}^2 = \left( \frac{m_{i} - k_{s}}{h_{m}} \right)^2 + \left( \frac{\tau_{i} - \tau}{h_{\tau}} \right)^2\)</span></p></li>
</ul>
<p>Then the unnormalized Gaussian weight for option <span class="math notranslate nohighlight">\(i\)</span> is:</p>
<div class="math notranslate nohighlight">
\[
w_{i}^* = \exp\left( -\frac{1}{2} d_{i}^2 \right)
\]</div>
<p>The normalized kernel weight:</p>
<div class="math notranslate nohighlight">
\[
w_{i} = \frac{w_{i}^*}{\sum_j w_j^*}
\]</div>
</section>
<hr class="docutils" />
<section id="option-elasticity">
<h4>2. Option Elasticity<a class="headerlink" href="#option-elasticity" title="Link to this heading">#</a></h4>
<p>Let:</p>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\(S_{t}\)</span> = underlying index level at time <span class="math notranslate nohighlight">\(t\)</span></p></li>
<li><p><span class="math notranslate nohighlight">\(P_{i}\)</span> = price of option <span class="math notranslate nohighlight">\(i\)</span></p></li>
<li><p><span class="math notranslate nohighlight">\(\Delta_{i}\)</span> = option delta</p></li>
</ul>
<p>Then:</p>
<div class="math notranslate nohighlight">
\[
\varepsilon_{i} = \frac{S_t \cdot \Delta_{i}}{P_{i}}
\]</div>
</section>
<hr class="docutils" />
<section id="arithmetic-return-of-option-i">
<h4>3. Arithmetic Return of Option <span class="math notranslate nohighlight">\(i\)</span><a class="headerlink" href="#arithmetic-return-of-option-i" title="Link to this heading">#</a></h4>
<p>Let:</p>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\(P_{i,t-1}\)</span> = price of option <span class="math notranslate nohighlight">\(i\)</span> at time <span class="math notranslate nohighlight">\(t-1\)</span></p></li>
<li><p><span class="math notranslate nohighlight">\(P_{i,t}\)</span> = price of option <span class="math notranslate nohighlight">\(i\)</span> at time <span class="math notranslate nohighlight">\(t\)</span></p></li>
</ul>
<p>Then:</p>
<div class="math notranslate nohighlight">
\[
r_{i} = \frac{P_{i,t} - P_{i,t-1}}{P_{i,t-1}}
\]</div>
</section>
<hr class="docutils" />
<section id="leverage-adjusted-portfolio-construction">
<h4>4. Leverage-Adjusted Portfolio Construction<a class="headerlink" href="#leverage-adjusted-portfolio-construction" title="Link to this heading">#</a></h4>
<p>Let:</p>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\(r_{f}\)</span> = risk-free rate on day <span class="math notranslate nohighlight">\(t\)</span></p></li>
</ul>
<p>The leverage-adjusted return of the call portfolio is:</p>
<div class="math notranslate nohighlight">
\[
R_t^{call} = \sum_{i} w_{i} \cdot \frac{1}{\varepsilon_{i}} \cdot r_{i} + \left(1 - \sum_{i} w_{i} \cdot \frac{1}{\varepsilon_{i}} \right) \cdot r_f
\]</div>
<p>The leverage-adjusted return of the put portfolio is:</p>
<div class="math notranslate nohighlight">
\[
R_t^{put} = -\sum_{i} w_{i} \cdot \frac{1}{\varepsilon_{i}} \cdot r_{i} + \left(1 + \sum_{i} w_{i} \cdot \frac{1}{\varepsilon_{i}} \right) \cdot r_f
\]</div>
<p>Below we implement this process.</p>
</section>
</section>
<section id="implementation">
<h3>Implementation<a class="headerlink" href="#implementation" title="Link to this heading">#</a></h3>
<section id="build-the-ftsfa-id-for-each-portfolio">
<h4>1. Build the FTSFA ID for each portfolio<a class="headerlink" href="#build-the-ftsfa-id-for-each-portfolio" title="Link to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># identify the maturity ID based on the closest maturity to 30, 60, or 90 days</span>
<span class="n">maturity_id</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
    <span class="p">(</span>
        <span class="nb">abs</span><span class="p">(</span><span class="n">spx_filtered</span><span class="p">[</span><span class="s2">&quot;days_to_maturity&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">days</span> <span class="o">-</span> <span class="mi">30</span><span class="p">),</span>
        <span class="nb">abs</span><span class="p">(</span><span class="n">spx_filtered</span><span class="p">[</span><span class="s2">&quot;days_to_maturity&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">days</span> <span class="o">-</span> <span class="mi">60</span><span class="p">),</span>
        <span class="nb">abs</span><span class="p">(</span><span class="n">spx_filtered</span><span class="p">[</span><span class="s2">&quot;days_to_maturity&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">days</span> <span class="o">-</span> <span class="mi">90</span><span class="p">),</span>
    <span class="p">),</span>
    <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">maturity_id</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="mi">30</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">90</span><span class="p">]</span>
<span class="n">spx_filtered</span><span class="p">[</span><span class="s2">&quot;maturity_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">maturity_id</span><span class="o">.</span><span class="n">idxmin</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">spx_filtered</span><span class="p">[</span><span class="s2">&quot;ftfsa_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">spx_filtered</span><span class="p">[</span><span class="s2">&quot;cp_flag&quot;</span><span class="p">]</span>
    <span class="o">+</span> <span class="s2">&quot;_&quot;</span>
    <span class="o">+</span> <span class="p">(</span><span class="n">spx_filtered</span><span class="p">[</span><span class="s2">&quot;moneyness_id&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
        <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">))</span> <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">notnull</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="ow">and</span> <span class="n">x</span> <span class="o">==</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="o">+</span> <span class="s2">&quot;_&quot;</span>
    <span class="o">+</span> <span class="n">spx_filtered</span><span class="p">[</span><span class="s2">&quot;maturity_id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
<span class="p">)</span>

<span class="c1"># set index to ftfsa_id and date</span>
<span class="n">spx_filtered</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s2">&quot;ftfsa_id&quot;</span><span class="p">,</span> <span class="s2">&quot;date&quot;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">spx_filtered</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th>exdate</th>
      <th>moneyness</th>
      <th>secid</th>
      <th>open</th>
      <th>close</th>
      <th>cp_flag</th>
      <th>IV</th>
      <th>tb_m3</th>
      <th>volume</th>
      <th>open_interest</th>
      <th>...</th>
      <th>pc_parity_int_rate</th>
      <th>intrinsic</th>
      <th>log_iv</th>
      <th>fitted_iv</th>
      <th>rel_distance_iv</th>
      <th>moneyness_bin</th>
      <th>stdev_iv_moneyness_bin</th>
      <th>is_outlier_iv</th>
      <th>moneyness_id</th>
      <th>maturity_id</th>
    </tr>
    <tr>
      <th>ftfsa_id</th>
      <th>date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>C_1000_30</th>
      <th>1996-01-04</th>
      <td>1996-01-20</td>
      <td>0.987534</td>
      <td>108105.0</td>
      <td>621.32</td>
      <td>617.70</td>
      <td>C</td>
      <td>0.082711</td>
      <td>5.04</td>
      <td>444.0</td>
      <td>5905.0</td>
      <td>...</td>
      <td>0.015898</td>
      <td>7.70</td>
      <td>-2.492403</td>
      <td>-2.377298</td>
      <td>4.841838</td>
      <td>(0.975, 1.0]</td>
      <td>3.516840</td>
      <td>False</td>
      <td>1.000</td>
      <td>30</td>
    </tr>
    <tr>
      <th>C_1025_30</th>
      <th>1996-01-04</th>
      <td>1996-01-20</td>
      <td>1.019913</td>
      <td>108105.0</td>
      <td>621.32</td>
      <td>617.70</td>
      <td>C</td>
      <td>0.097356</td>
      <td>5.04</td>
      <td>4022.0</td>
      <td>5969.0</td>
      <td>...</td>
      <td>0.015898</td>
      <td>0.00</td>
      <td>-2.329381</td>
      <td>-2.285771</td>
      <td>1.907866</td>
      <td>(1.0, 1.025]</td>
      <td>5.219336</td>
      <td>False</td>
      <td>1.025</td>
      <td>30</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">C_1050_30</th>
      <th>1996-01-04</th>
      <td>1996-01-20</td>
      <td>1.028007</td>
      <td>108105.0</td>
      <td>621.32</td>
      <td>617.70</td>
      <td>C</td>
      <td>0.101756</td>
      <td>5.04</td>
      <td>1627.0</td>
      <td>6224.0</td>
      <td>...</td>
      <td>0.015898</td>
      <td>0.00</td>
      <td>-2.285177</td>
      <td>-2.264082</td>
      <td>0.931727</td>
      <td>(1.025, 1.05]</td>
      <td>4.396845</td>
      <td>False</td>
      <td>1.050</td>
      <td>30</td>
    </tr>
    <tr>
      <th>1996-01-04</th>
      <td>1996-01-20</td>
      <td>1.036102</td>
      <td>108105.0</td>
      <td>621.32</td>
      <td>617.70</td>
      <td>C</td>
      <td>0.100588</td>
      <td>5.04</td>
      <td>0.0</td>
      <td>6593.0</td>
      <td>...</td>
      <td>0.015898</td>
      <td>0.00</td>
      <td>-2.296722</td>
      <td>-2.242870</td>
      <td>2.401027</td>
      <td>(1.025, 1.05]</td>
      <td>4.396845</td>
      <td>False</td>
      <td>1.050</td>
      <td>30</td>
    </tr>
    <tr>
      <th>C_975_30</th>
      <th>1996-01-04</th>
      <td>1996-02-17</td>
      <td>0.963251</td>
      <td>108105.0</td>
      <td>621.32</td>
      <td>617.70</td>
      <td>C</td>
      <td>0.071852</td>
      <td>5.04</td>
      <td>3.0</td>
      <td>34.0</td>
      <td>...</td>
      <td>0.014622</td>
      <td>22.70</td>
      <td>-2.633147</td>
      <td>-2.563785</td>
      <td>2.705450</td>
      <td>(0.95, 0.975]</td>
      <td>2.301503</td>
      <td>False</td>
      <td>0.975</td>
      <td>30</td>
    </tr>
    <tr>
      <th>...</th>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>P_1050_90</th>
      <th>2019-12-31</th>
      <td>2020-06-19</td>
      <td>1.044639</td>
      <td>108105.0</td>
      <td>3215.18</td>
      <td>3230.78</td>
      <td>P</td>
      <td>0.117063</td>
      <td>1.52</td>
      <td>0.0</td>
      <td>395.0</td>
      <td>...</td>
      <td>0.014769</td>
      <td>144.22</td>
      <td>-2.145043</td>
      <td>-2.132215</td>
      <td>0.601630</td>
      <td>(1.025, 1.05]</td>
      <td>4.396845</td>
      <td>False</td>
      <td>1.050</td>
      <td>90</td>
    </tr>
    <tr>
      <th rowspan="3" valign="top">P_1075_90</th>
      <th>2019-12-31</th>
      <td>2020-06-19</td>
      <td>1.052377</td>
      <td>108105.0</td>
      <td>3215.18</td>
      <td>3230.78</td>
      <td>P</td>
      <td>0.113900</td>
      <td>1.52</td>
      <td>0.0</td>
      <td>163.0</td>
      <td>...</td>
      <td>0.014769</td>
      <td>169.22</td>
      <td>-2.172434</td>
      <td>-2.165558</td>
      <td>0.317525</td>
      <td>(1.05, 1.075]</td>
      <td>5.236635</td>
      <td>False</td>
      <td>1.075</td>
      <td>90</td>
    </tr>
    <tr>
      <th>2019-12-31</th>
      <td>2020-06-19</td>
      <td>1.060116</td>
      <td>108105.0</td>
      <td>3215.18</td>
      <td>3230.78</td>
      <td>P</td>
      <td>0.110925</td>
      <td>1.52</td>
      <td>20.0</td>
      <td>310.0</td>
      <td>...</td>
      <td>0.014769</td>
      <td>194.22</td>
      <td>-2.198901</td>
      <td>-2.199596</td>
      <td>-0.031616</td>
      <td>(1.05, 1.075]</td>
      <td>5.236635</td>
      <td>False</td>
      <td>1.075</td>
      <td>90</td>
    </tr>
    <tr>
      <th>2019-12-31</th>
      <td>2020-06-19</td>
      <td>1.067854</td>
      <td>108105.0</td>
      <td>3215.18</td>
      <td>3230.78</td>
      <td>P</td>
      <td>0.108540</td>
      <td>1.52</td>
      <td>0.0</td>
      <td>12.0</td>
      <td>...</td>
      <td>0.014769</td>
      <td>219.22</td>
      <td>-2.220637</td>
      <td>-2.234330</td>
      <td>-0.612848</td>
      <td>(1.05, 1.075]</td>
      <td>5.236635</td>
      <td>False</td>
      <td>1.075</td>
      <td>90</td>
    </tr>
    <tr>
      <th>P_1100_90</th>
      <th>2019-12-31</th>
      <td>2020-06-19</td>
      <td>1.075592</td>
      <td>108105.0</td>
      <td>3215.18</td>
      <td>3230.78</td>
      <td>P</td>
      <td>0.106814</td>
      <td>1.52</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>...</td>
      <td>0.014769</td>
      <td>244.22</td>
      <td>-2.236666</td>
      <td>-2.269758</td>
      <td>-1.457925</td>
      <td>(1.075, 1.1]</td>
      <td>5.723928</td>
      <td>False</td>
      <td>1.100</td>
      <td>90</td>
    </tr>
  </tbody>
</table>
<p>2676696 rows × 26 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">portfolio_ids</span> <span class="o">=</span> <span class="n">spx_filtered</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="s2">&quot;ftfsa_id&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
<span class="n">portfolio_ids</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Index([&#39;C_1000_30&#39;, &#39;C_1025_30&#39;, &#39;C_1050_30&#39;, &#39;C_975_30&#39;, &#39;C_1075_30&#39;,
       &#39;C_950_60&#39;, &#39;C_975_60&#39;, &#39;C_1000_60&#39;, &#39;C_1025_60&#39;, &#39;C_1050_60&#39;,
       &#39;C_1075_60&#39;, &#39;C_1100_30&#39;, &#39;C_900_60&#39;, &#39;C_925_60&#39;, &#39;C_950_30&#39;,
       &#39;C_1100_60&#39;, &#39;C_925_30&#39;, &#39;C_900_30&#39;, &#39;C_900_90&#39;, &#39;C_925_90&#39;, &#39;C_950_90&#39;,
       &#39;C_975_90&#39;, &#39;C_1050_90&#39;, &#39;C_1000_90&#39;, &#39;C_1025_90&#39;, &#39;C_1075_90&#39;,
       &#39;C_1100_90&#39;, &#39;P_1000_30&#39;, &#39;P_1025_30&#39;, &#39;P_1050_30&#39;, &#39;P_975_30&#39;,
       &#39;P_1075_30&#39;, &#39;P_950_60&#39;, &#39;P_975_60&#39;, &#39;P_1000_60&#39;, &#39;P_1025_60&#39;,
       &#39;P_1050_60&#39;, &#39;P_1075_60&#39;, &#39;P_1100_30&#39;, &#39;P_900_60&#39;, &#39;P_925_60&#39;,
       &#39;P_950_30&#39;, &#39;P_1100_60&#39;, &#39;P_925_30&#39;, &#39;P_900_30&#39;, &#39;P_900_90&#39;, &#39;P_925_90&#39;,
       &#39;P_950_90&#39;, &#39;P_975_90&#39;, &#39;P_1050_90&#39;, &#39;P_1000_90&#39;, &#39;P_1025_90&#39;,
       &#39;P_1075_90&#39;, &#39;P_1100_90&#39;],
      dtype=&#39;object&#39;, name=&#39;ftfsa_id&#39;)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">spx_filtered</span><span class="p">[</span><span class="s2">&quot;days_to_maturity&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>count                       2676696
mean     56 days 07:55:28.214186444
std      36 days 18:30:26.100585916
min                 7 days 00:00:00
25%                29 days 00:00:00
50%                49 days 00:00:00
75%                74 days 00:00:00
max               180 days 00:00:00
Name: days_to_maturity, dtype: object
</pre></div>
</div>
</div>
</div>
</section>
<section id="calculate-option-elasticity-and-daily-kernel-weighting-for-candidate-options-for-each-portfolio">
<h4>2. Calculate option elasticity and daily kernel weighting for candidate options for each portfolio.<a class="headerlink" href="#calculate-option-elasticity-and-daily-kernel-weighting-for-candidate-options-for-each-portfolio" title="Link to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">spx_mod</span> <span class="o">=</span> <span class="n">spx_filtered</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<span class="c1"># calculate option delta and elasticity</span>
<span class="n">spx_mod</span> <span class="o">=</span> <span class="n">calc_option_delta_elasticity</span><span class="p">(</span><span class="n">spx_mod</span><span class="p">)</span>
<span class="c1"># calculate daily kernel weights for candidate options</span>
<span class="n">spx_mod</span> <span class="o">=</span> <span class="n">calc_kernel_weights</span><span class="p">(</span><span class="n">spx_mod</span><span class="p">)</span>
<span class="n">spx_mod</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>ftfsa_id</th>
      <th>date</th>
      <th>exdate</th>
      <th>moneyness</th>
      <th>secid</th>
      <th>open</th>
      <th>close</th>
      <th>cp_flag</th>
      <th>IV</th>
      <th>tb_m3</th>
      <th>...</th>
      <th>rel_distance_iv</th>
      <th>moneyness_bin</th>
      <th>stdev_iv_moneyness_bin</th>
      <th>is_outlier_iv</th>
      <th>moneyness_id</th>
      <th>maturity_id</th>
      <th>option_delta</th>
      <th>option_elasticity</th>
      <th>days_to_maturity_int</th>
      <th>kernel_weight</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>C_1000_30</td>
      <td>1996-01-04</td>
      <td>1996-01-20</td>
      <td>0.987534</td>
      <td>108105.0</td>
      <td>621.32</td>
      <td>617.70</td>
      <td>C</td>
      <td>0.082711</td>
      <td>5.04</td>
      <td>...</td>
      <td>4.841838</td>
      <td>(0.975, 1.0]</td>
      <td>3.516840</td>
      <td>False</td>
      <td>1.000</td>
      <td>30</td>
      <td>0.805272</td>
      <td>48.826136</td>
      <td>16</td>
      <td>4.123556e-01</td>
    </tr>
    <tr>
      <th>1</th>
      <td>C_1025_30</td>
      <td>1996-01-04</td>
      <td>1996-01-20</td>
      <td>1.019913</td>
      <td>108105.0</td>
      <td>621.32</td>
      <td>617.70</td>
      <td>C</td>
      <td>0.097356</td>
      <td>5.04</td>
      <td>...</td>
      <td>1.907866</td>
      <td>(1.0, 1.025]</td>
      <td>5.219336</td>
      <td>False</td>
      <td>1.025</td>
      <td>30</td>
      <td>0.198018</td>
      <td>95.465702</td>
      <td>16</td>
      <td>1.000000e+00</td>
    </tr>
    <tr>
      <th>2</th>
      <td>C_1050_30</td>
      <td>1996-01-04</td>
      <td>1996-01-20</td>
      <td>1.028007</td>
      <td>108105.0</td>
      <td>621.32</td>
      <td>617.70</td>
      <td>C</td>
      <td>0.101756</td>
      <td>5.04</td>
      <td>...</td>
      <td>0.931727</td>
      <td>(1.025, 1.05]</td>
      <td>4.396845</td>
      <td>False</td>
      <td>1.050</td>
      <td>30</td>
      <td>0.118568</td>
      <td>106.529727</td>
      <td>16</td>
      <td>2.829909e-01</td>
    </tr>
    <tr>
      <th>3</th>
      <td>C_1050_30</td>
      <td>1996-01-04</td>
      <td>1996-01-20</td>
      <td>1.036102</td>
      <td>108105.0</td>
      <td>621.32</td>
      <td>617.70</td>
      <td>C</td>
      <td>0.100588</td>
      <td>5.04</td>
      <td>...</td>
      <td>2.401027</td>
      <td>(1.025, 1.05]</td>
      <td>4.396845</td>
      <td>False</td>
      <td>1.050</td>
      <td>30</td>
      <td>0.058374</td>
      <td>128.204965</td>
      <td>16</td>
      <td>7.170091e-01</td>
    </tr>
    <tr>
      <th>4</th>
      <td>C_975_30</td>
      <td>1996-01-04</td>
      <td>1996-02-17</td>
      <td>0.963251</td>
      <td>108105.0</td>
      <td>621.32</td>
      <td>617.70</td>
      <td>C</td>
      <td>0.071852</td>
      <td>5.04</td>
      <td>...</td>
      <td>2.705450</td>
      <td>(0.95, 0.975]</td>
      <td>2.301503</td>
      <td>False</td>
      <td>0.975</td>
      <td>30</td>
      <td>0.960529</td>
      <td>23.041498</td>
      <td>44</td>
      <td>4.015525e-01</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>2676691</th>
      <td>P_1050_90</td>
      <td>2019-12-31</td>
      <td>2020-06-19</td>
      <td>1.044639</td>
      <td>108105.0</td>
      <td>3215.18</td>
      <td>3230.78</td>
      <td>P</td>
      <td>0.117063</td>
      <td>1.52</td>
      <td>...</td>
      <td>0.601630</td>
      <td>(1.025, 1.05]</td>
      <td>4.396845</td>
      <td>False</td>
      <td>1.050</td>
      <td>90</td>
      <td>-0.661333</td>
      <td>-11.093570</td>
      <td>171</td>
      <td>5.365533e-16</td>
    </tr>
    <tr>
      <th>2676692</th>
      <td>P_1075_90</td>
      <td>2019-12-31</td>
      <td>2020-06-19</td>
      <td>1.052377</td>
      <td>108105.0</td>
      <td>3215.18</td>
      <td>3230.78</td>
      <td>P</td>
      <td>0.113900</td>
      <td>1.52</td>
      <td>...</td>
      <td>0.317525</td>
      <td>(1.05, 1.075]</td>
      <td>5.236635</td>
      <td>False</td>
      <td>1.075</td>
      <td>90</td>
      <td>-0.700041</td>
      <td>-10.839582</td>
      <td>171</td>
      <td>1.775800e-16</td>
    </tr>
    <tr>
      <th>2676693</th>
      <td>P_1075_90</td>
      <td>2019-12-31</td>
      <td>2020-06-19</td>
      <td>1.060116</td>
      <td>108105.0</td>
      <td>3215.18</td>
      <td>3230.78</td>
      <td>P</td>
      <td>0.110925</td>
      <td>1.52</td>
      <td>...</td>
      <td>-0.031616</td>
      <td>(1.05, 1.075]</td>
      <td>5.236635</td>
      <td>False</td>
      <td>1.075</td>
      <td>90</td>
      <td>-0.737984</td>
      <td>-10.556841</td>
      <td>171</td>
      <td>4.495126e-16</td>
    </tr>
    <tr>
      <th>2676694</th>
      <td>P_1075_90</td>
      <td>2019-12-31</td>
      <td>2020-06-19</td>
      <td>1.067854</td>
      <td>108105.0</td>
      <td>3215.18</td>
      <td>3230.78</td>
      <td>P</td>
      <td>0.108540</td>
      <td>1.52</td>
      <td>...</td>
      <td>-0.612848</td>
      <td>(1.05, 1.075]</td>
      <td>5.236635</td>
      <td>False</td>
      <td>1.075</td>
      <td>90</td>
      <td>-0.773579</td>
      <td>-10.226122</td>
      <td>171</td>
      <td>7.756405e-16</td>
    </tr>
    <tr>
      <th>2676695</th>
      <td>P_1100_90</td>
      <td>2019-12-31</td>
      <td>2020-06-19</td>
      <td>1.075592</td>
      <td>108105.0</td>
      <td>3215.18</td>
      <td>3230.78</td>
      <td>P</td>
      <td>0.106814</td>
      <td>1.52</td>
      <td>...</td>
      <td>-1.457925</td>
      <td>(1.075, 1.1]</td>
      <td>5.723928</td>
      <td>False</td>
      <td>1.100</td>
      <td>90</td>
      <td>-0.805867</td>
      <td>-9.854573</td>
      <td>171</td>
      <td>3.015839e-16</td>
    </tr>
  </tbody>
</table>
<p>2676696 rows × 32 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Kernel weight check: All portfolios should sum to 1.0.&quot;</span><span class="p">)</span>
<span class="n">spx_mod</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;date&quot;</span><span class="p">,</span> <span class="s2">&quot;ftfsa_id&quot;</span><span class="p">])[</span><span class="s2">&quot;kernel_weight&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Kernel weight check: All portfolios should sum to 1.0.
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>kernel_weight
1.0    156522
Name: count, dtype: int64
</pre></div>
</div>
</div>
</div>
</section>
<section id="remove-options-from-the-portfolio-with-weights-lower-than-1">
<h4>3. Remove options from the portfolio with weights lower than 1%<a class="headerlink" href="#remove-options-from-the-portfolio-with-weights-lower-than-1" title="Link to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">spx_mod</span> <span class="o">=</span> <span class="n">spx_mod</span><span class="p">[</span><span class="n">spx_mod</span><span class="p">[</span><span class="s2">&quot;kernel_weight&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mf">0.01</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">spx_mod</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>ftfsa_id</th>
      <th>date</th>
      <th>exdate</th>
      <th>moneyness</th>
      <th>secid</th>
      <th>open</th>
      <th>close</th>
      <th>cp_flag</th>
      <th>IV</th>
      <th>tb_m3</th>
      <th>...</th>
      <th>rel_distance_iv</th>
      <th>moneyness_bin</th>
      <th>stdev_iv_moneyness_bin</th>
      <th>is_outlier_iv</th>
      <th>moneyness_id</th>
      <th>maturity_id</th>
      <th>option_delta</th>
      <th>option_elasticity</th>
      <th>days_to_maturity_int</th>
      <th>kernel_weight</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>C_1000_30</td>
      <td>1996-01-04</td>
      <td>1996-01-20</td>
      <td>0.987534</td>
      <td>108105.0</td>
      <td>621.32</td>
      <td>617.70</td>
      <td>C</td>
      <td>0.082711</td>
      <td>5.04</td>
      <td>...</td>
      <td>4.841838</td>
      <td>(0.975, 1.0]</td>
      <td>3.516840</td>
      <td>False</td>
      <td>1.000</td>
      <td>30</td>
      <td>0.805272</td>
      <td>48.826136</td>
      <td>16</td>
      <td>0.412356</td>
    </tr>
    <tr>
      <th>1</th>
      <td>C_1025_30</td>
      <td>1996-01-04</td>
      <td>1996-01-20</td>
      <td>1.019913</td>
      <td>108105.0</td>
      <td>621.32</td>
      <td>617.70</td>
      <td>C</td>
      <td>0.097356</td>
      <td>5.04</td>
      <td>...</td>
      <td>1.907866</td>
      <td>(1.0, 1.025]</td>
      <td>5.219336</td>
      <td>False</td>
      <td>1.025</td>
      <td>30</td>
      <td>0.198018</td>
      <td>95.465702</td>
      <td>16</td>
      <td>1.000000</td>
    </tr>
    <tr>
      <th>2</th>
      <td>C_1050_30</td>
      <td>1996-01-04</td>
      <td>1996-01-20</td>
      <td>1.028007</td>
      <td>108105.0</td>
      <td>621.32</td>
      <td>617.70</td>
      <td>C</td>
      <td>0.101756</td>
      <td>5.04</td>
      <td>...</td>
      <td>0.931727</td>
      <td>(1.025, 1.05]</td>
      <td>4.396845</td>
      <td>False</td>
      <td>1.050</td>
      <td>30</td>
      <td>0.118568</td>
      <td>106.529727</td>
      <td>16</td>
      <td>0.282991</td>
    </tr>
    <tr>
      <th>3</th>
      <td>C_1050_30</td>
      <td>1996-01-04</td>
      <td>1996-01-20</td>
      <td>1.036102</td>
      <td>108105.0</td>
      <td>621.32</td>
      <td>617.70</td>
      <td>C</td>
      <td>0.100588</td>
      <td>5.04</td>
      <td>...</td>
      <td>2.401027</td>
      <td>(1.025, 1.05]</td>
      <td>4.396845</td>
      <td>False</td>
      <td>1.050</td>
      <td>30</td>
      <td>0.058374</td>
      <td>128.204965</td>
      <td>16</td>
      <td>0.717009</td>
    </tr>
    <tr>
      <th>4</th>
      <td>C_975_30</td>
      <td>1996-01-04</td>
      <td>1996-02-17</td>
      <td>0.963251</td>
      <td>108105.0</td>
      <td>621.32</td>
      <td>617.70</td>
      <td>C</td>
      <td>0.071852</td>
      <td>5.04</td>
      <td>...</td>
      <td>2.705450</td>
      <td>(0.95, 0.975]</td>
      <td>2.301503</td>
      <td>False</td>
      <td>0.975</td>
      <td>30</td>
      <td>0.960529</td>
      <td>23.041498</td>
      <td>44</td>
      <td>0.401552</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>1926209</th>
      <td>P_1100_90</td>
      <td>2019-12-31</td>
      <td>2020-03-31</td>
      <td>1.077139</td>
      <td>108105.0</td>
      <td>3215.18</td>
      <td>3230.78</td>
      <td>P</td>
      <td>0.102622</td>
      <td>1.52</td>
      <td>...</td>
      <td>-2.816445</td>
      <td>(1.075, 1.1]</td>
      <td>5.723928</td>
      <td>False</td>
      <td>1.100</td>
      <td>90</td>
      <td>-0.911590</td>
      <td>-11.547335</td>
      <td>91</td>
      <td>0.066978</td>
    </tr>
    <tr>
      <th>1926210</th>
      <td>P_1100_90</td>
      <td>2019-12-31</td>
      <td>2020-03-31</td>
      <td>1.080234</td>
      <td>108105.0</td>
      <td>3215.18</td>
      <td>3230.78</td>
      <td>P</td>
      <td>0.099399</td>
      <td>1.52</td>
      <td>...</td>
      <td>-2.052300</td>
      <td>(1.075, 1.1]</td>
      <td>5.723928</td>
      <td>False</td>
      <td>1.100</td>
      <td>90</td>
      <td>-0.927007</td>
      <td>-11.357435</td>
      <td>91</td>
      <td>0.102163</td>
    </tr>
    <tr>
      <th>1926211</th>
      <td>P_1100_90</td>
      <td>2019-12-31</td>
      <td>2020-03-31</td>
      <td>1.083330</td>
      <td>108105.0</td>
      <td>3215.18</td>
      <td>3230.78</td>
      <td>P</td>
      <td>0.102206</td>
      <td>1.52</td>
      <td>...</td>
      <td>-3.820268</td>
      <td>(1.075, 1.1]</td>
      <td>5.723928</td>
      <td>False</td>
      <td>1.100</td>
      <td>90</td>
      <td>-0.929031</td>
      <td>-10.968371</td>
      <td>91</td>
      <td>0.146563</td>
    </tr>
    <tr>
      <th>1926212</th>
      <td>P_1100_90</td>
      <td>2019-12-31</td>
      <td>2020-03-31</td>
      <td>1.091068</td>
      <td>108105.0</td>
      <td>3215.18</td>
      <td>3230.78</td>
      <td>P</td>
      <td>0.103736</td>
      <td>1.52</td>
      <td>...</td>
      <td>-5.884824</td>
      <td>(1.075, 1.1]</td>
      <td>5.723928</td>
      <td>False</td>
      <td>1.100</td>
      <td>90</td>
      <td>-0.943358</td>
      <td>-10.241205</td>
      <td>91</td>
      <td>0.276281</td>
    </tr>
    <tr>
      <th>1926213</th>
      <td>P_1100_90</td>
      <td>2019-12-31</td>
      <td>2020-03-31</td>
      <td>1.098806</td>
      <td>108105.0</td>
      <td>3215.18</td>
      <td>3230.78</td>
      <td>P</td>
      <td>0.105558</td>
      <td>1.52</td>
      <td>...</td>
      <td>-8.008885</td>
      <td>(1.075, 1.1]</td>
      <td>5.723928</td>
      <td>False</td>
      <td>1.100</td>
      <td>90</td>
      <td>-0.954434</td>
      <td>-9.582242</td>
      <td>91</td>
      <td>0.355017</td>
    </tr>
  </tbody>
</table>
<p>1926214 rows × 32 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># check elasticity &gt; 1 for call options and &lt; -1 for put options</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Elasticity &gt; 1 for call options?&quot;</span><span class="p">)</span>
<span class="n">spx_mod</span><span class="p">[</span><span class="n">spx_mod</span><span class="p">[</span><span class="s2">&quot;cp_flag&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;C&quot;</span><span class="p">][</span><span class="s2">&quot;option_elasticity&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">describe</span><span class="p">()[</span><span class="s2">&quot;min&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">1.0</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Elasticity &gt; 1 for call options?
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>True
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Elasticity &lt; -1 for put options?&quot;</span><span class="p">)</span>
<span class="n">spx_mod</span><span class="p">[</span><span class="n">spx_mod</span><span class="p">[</span><span class="s2">&quot;cp_flag&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;P&quot;</span><span class="p">][</span><span class="s2">&quot;option_elasticity&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">describe</span><span class="p">()[</span><span class="s2">&quot;max&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">1.0</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Elasticity &lt; -1 for put options?
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>True
</pre></div>
</div>
</div>
</div>
</section>
<section id="calculate-the-daily-arithmetic-return-and-the-leverage-adjusted-return-of-each-portfolio">
<h4>4. Calculate the daily arithmetic return and the leverage-adjusted return of each portfolio.<a class="headerlink" href="#calculate-the-daily-arithmetic-return-and-the-leverage-adjusted-return-of-each-portfolio" title="Link to this heading">#</a></h4>
<p>On each trading day, the return of a portfolio is calculated as the <u>weighted average return of the set of candidate options that comprise a single day’s option portfolio</u>. The weighting used is the Gaussian kernel weight calculated earlier. Thus the daily return from period <span class="math notranslate nohighlight">\(t\)</span> to <span class="math notranslate nohighlight">\(t+1\)</span> represents the return from holding a set of candidate options, weighted using the kernel weights as of <span class="math notranslate nohighlight">\(t\)</span>, from period <span class="math notranslate nohighlight">\(t\)</span> to <span class="math notranslate nohighlight">\(t+1\)</span>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">portfolio_returns</span> <span class="o">=</span> <span class="n">compute_cjs_return_leverage_investment</span><span class="p">(</span><span class="n">spx_mod</span><span class="p">)</span>

<span class="c1"># Preview result</span>
<span class="n">portfolio_returns</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s2">&quot;date&quot;</span><span class="p">,</span> <span class="s2">&quot;ftfsa_id&quot;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">portfolio_returns</span> <span class="o">=</span> <span class="n">portfolio_returns</span><span class="o">.</span><span class="n">pivot_table</span><span class="p">(</span>
    <span class="n">index</span><span class="o">=</span><span class="s2">&quot;date&quot;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s2">&quot;ftfsa_id&quot;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="s2">&quot;portfolio_return&quot;</span>
<span class="p">)</span>
<span class="c1"># daily_returns = pd.DataFrame(np.where(portfolio_returns &gt; 1.0, np.nan, portfolio_returns), index=portfolio_returns.index, columns=portfolio_returns.columns)</span>
<span class="n">daily_returns</span> <span class="o">=</span> <span class="n">portfolio_returns</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">daily_returns</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>ftfsa_id</th>
      <th>C_1000_30</th>
      <th>C_1000_60</th>
      <th>C_1000_90</th>
      <th>C_1025_30</th>
      <th>C_1025_60</th>
      <th>C_1025_90</th>
      <th>C_1050_30</th>
      <th>C_1050_60</th>
      <th>C_1050_90</th>
      <th>C_1075_30</th>
      <th>...</th>
      <th>P_900_90</th>
      <th>P_925_30</th>
      <th>P_925_60</th>
      <th>P_925_90</th>
      <th>P_950_30</th>
      <th>P_950_60</th>
      <th>P_950_90</th>
      <th>P_975_30</th>
      <th>P_975_60</th>
      <th>P_975_90</th>
    </tr>
    <tr>
      <th>date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1996-01-04</th>
      <td>0.002171</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.000198</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>-0.003106</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.003393</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1996-01-05</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>-0.002985</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.004674</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1996-01-09</th>
      <td>-0.004362</td>
      <td>-0.005736</td>
      <td>NaN</td>
      <td>0.011077</td>
      <td>0.000193</td>
      <td>NaN</td>
      <td>0.039018</td>
      <td>0.000195</td>
      <td>NaN</td>
      <td>0.008154</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.000191</td>
      <td>NaN</td>
      <td>0.011241</td>
      <td>0.007766</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1996-01-10</th>
      <td>-0.001291</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>-0.003064</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>-0.005087</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1996-01-22</th>
      <td>-0.002792</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>-0.004186</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.004054</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.016734</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>2019-12-24</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>-0.001959</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>0.000877</td>
      <td>NaN</td>
      <td>0.000702</td>
      <td>-0.003096</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.007690</td>
      <td>-0.007144</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2019-12-26</th>
      <td>0.000177</td>
      <td>-0.000588</td>
      <td>-0.001565</td>
      <td>0.049612</td>
      <td>0.000451</td>
      <td>-0.001096</td>
      <td>0.001201</td>
      <td>0.000729</td>
      <td>NaN</td>
      <td>0.001499</td>
      <td>...</td>
      <td>0.000925</td>
      <td>0.000619</td>
      <td>0.000816</td>
      <td>0.001072</td>
      <td>0.000456</td>
      <td>0.000826</td>
      <td>0.000696</td>
      <td>0.002388</td>
      <td>0.000837</td>
      <td>0.000776</td>
    </tr>
    <tr>
      <th>2019-12-27</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>0.001085</td>
      <td>NaN</td>
      <td>0.000463</td>
      <td>0.002847</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.002921</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2019-12-30</th>
      <td>0.000195</td>
      <td>-0.000363</td>
      <td>-0.000944</td>
      <td>0.000539</td>
      <td>0.000115</td>
      <td>-0.001000</td>
      <td>0.001502</td>
      <td>-0.000179</td>
      <td>-0.001638</td>
      <td>0.000554</td>
      <td>...</td>
      <td>0.001061</td>
      <td>0.000485</td>
      <td>0.000862</td>
      <td>0.000741</td>
      <td>0.000373</td>
      <td>0.000779</td>
      <td>0.000816</td>
      <td>0.000222</td>
      <td>0.000845</td>
      <td>0.001032</td>
    </tr>
    <tr>
      <th>2019-12-31</th>
      <td>0.000164</td>
      <td>-0.000746</td>
      <td>-0.001073</td>
      <td>0.000216</td>
      <td>-0.000542</td>
      <td>-0.001064</td>
      <td>0.000767</td>
      <td>-0.000273</td>
      <td>-0.000936</td>
      <td>0.000142</td>
      <td>...</td>
      <td>0.000913</td>
      <td>0.000537</td>
      <td>0.000821</td>
      <td>0.000914</td>
      <td>0.000592</td>
      <td>0.000825</td>
      <td>0.000898</td>
      <td>0.000382</td>
      <td>0.000766</td>
      <td>0.000936</td>
    </tr>
  </tbody>
</table>
<p>3740 rows × 54 columns</p>
</div></div></div>
</div>
</section>
<section id="to-be-implemented-filling-nans">
<h4>5. (to be implemented) Filling NaNs<a class="headerlink" href="#to-be-implemented-filling-nans" title="Link to this heading">#</a></h4>
<p>CJS implement an multi-step process to deal with options with missing prices (detailed in section <strong>1.3 Portfolio Formation</strong> of the paper). We reserve the implementation this NaN-filling process for a future version of this dataset. For the current version, we compound the daily portfolio returns into monthly returns, which is the final form of the data utilized in the paper.</p>
</section>
<section id="compound-daily-portfolio-returns-to-monthly-final-54-portfolios-in-cjs">
<h4>6. Compound Daily Portfolio Returns to Monthly (final 54 portfolios in CJS)<a class="headerlink" href="#compound-daily-portfolio-returns-to-monthly-final-54-portfolios-in-cjs" title="Link to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">cjs_returns</span> <span class="o">=</span> <span class="n">daily_returns</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s2">&quot;M&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">prod</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">cjs_returns</span> <span class="o">=</span> <span class="n">cjs_returns</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">melt</span><span class="p">(</span>
    <span class="n">id_vars</span><span class="o">=</span><span class="s2">&quot;date&quot;</span><span class="p">,</span> <span class="n">var_name</span><span class="o">=</span><span class="s2">&quot;ftfsa_id&quot;</span><span class="p">,</span> <span class="n">value_name</span><span class="o">=</span><span class="s2">&quot;return&quot;</span>
<span class="p">)</span>
<span class="n">cjs_returns</span><span class="p">[</span><span class="s2">&quot;ftfsa_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;cjs_&quot;</span> <span class="o">+</span> <span class="n">cjs_returns</span><span class="p">[</span><span class="s2">&quot;ftfsa_id&quot;</span><span class="p">]</span>
<span class="n">cjs_returns</span> <span class="o">=</span> <span class="n">cjs_returns</span><span class="p">[[</span><span class="s2">&quot;ftfsa_id&quot;</span><span class="p">,</span> <span class="s2">&quot;date&quot;</span><span class="p">,</span> <span class="s2">&quot;return&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span>
    <span class="p">[</span><span class="s2">&quot;ftfsa_id&quot;</span><span class="p">,</span> <span class="s2">&quot;date&quot;</span><span class="p">]</span>
<span class="p">)</span>
<span class="c1"># save to data directory</span>
<span class="n">cjs_returns</span><span class="o">.</span><span class="n">to_parquet</span><span class="p">(</span>
    <span class="n">DATA_DIR</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;cjs_portfolio_returns_</span><span class="si">{</span><span class="n">DATE_RANGE</span><span class="si">}</span><span class="s2">.parquet&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="n">cjs_returns</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th>return</th>
    </tr>
    <tr>
      <th>ftfsa_id</th>
      <th>date</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="5" valign="top">cjs_C_1000_30</th>
      <th>1996-01-31</th>
      <td>-0.006272</td>
    </tr>
    <tr>
      <th>1996-02-29</th>
      <td>0.002888</td>
    </tr>
    <tr>
      <th>1996-03-31</th>
      <td>-0.002462</td>
    </tr>
    <tr>
      <th>1996-04-30</th>
      <td>0.036055</td>
    </tr>
    <tr>
      <th>1996-05-31</th>
      <td>0.003906</td>
    </tr>
    <tr>
      <th>...</th>
      <th>...</th>
      <td>...</td>
    </tr>
    <tr>
      <th rowspan="5" valign="top">cjs_P_975_90</th>
      <th>2019-08-31</th>
      <td>0.007421</td>
    </tr>
    <tr>
      <th>2019-09-30</th>
      <td>0.000517</td>
    </tr>
    <tr>
      <th>2019-10-31</th>
      <td>0.138853</td>
    </tr>
    <tr>
      <th>2019-11-30</th>
      <td>0.009941</td>
    </tr>
    <tr>
      <th>2019-12-31</th>
      <td>0.007702</td>
    </tr>
  </tbody>
</table>
<p>15552 rows × 1 columns</p>
</div></div></div>
</div>
</section>
</section>
</section>
<section id="construction-of-18-portfolio-return-series-in-he-kelly-manela-hkm-2017">
<h2>Construction of 18 Portfolio Return Series in He, Kelly, Manela (HKM 2017)<a class="headerlink" href="#construction-of-18-portfolio-return-series-in-he-kelly-manela-hkm-2017" title="Link to this heading">#</a></h2>
<p><em>HKM 2017</em> reduces the 54 portfolio return series constructed in CJS to 18 by taking an equal-weight average across the 3 maturities for the CJS portfolios with the same moneyness. Below we implement that procedure to obtain the final return series for the FTSFA.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">hkm_returns</span> <span class="o">=</span> <span class="n">cjs_returns</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
<span class="n">hkm_returns</span> <span class="o">=</span> <span class="n">hkm_returns</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
    <span class="nb">type</span><span class="o">=</span><span class="n">hkm_returns</span><span class="p">[</span><span class="s2">&quot;ftfsa_id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]),</span>
    <span class="n">moneyness_id</span><span class="o">=</span><span class="n">hkm_returns</span><span class="p">[</span><span class="s2">&quot;ftfsa_id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="mi">2</span><span class="p">]),</span>
    <span class="n">maturity_id</span><span class="o">=</span><span class="n">hkm_returns</span><span class="p">[</span><span class="s2">&quot;ftfsa_id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="mi">3</span><span class="p">]),</span>
<span class="p">)</span>
<span class="n">hkm_returns</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;ftfsa_id&quot;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">hkm_returns</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s2">&quot;date&quot;</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">,</span> <span class="s2">&quot;moneyness_id&quot;</span><span class="p">,</span> <span class="s2">&quot;maturity_id&quot;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">hkm_returns</span> <span class="o">=</span> <span class="n">hkm_returns</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;date&quot;</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">,</span> <span class="s2">&quot;moneyness_id&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">hkm_returns</span><span class="p">[</span><span class="s2">&quot;ftfsa_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s2">&quot;hkm_&quot;</span>
    <span class="o">+</span> <span class="n">hkm_returns</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span>
    <span class="o">+</span> <span class="s2">&quot;_&quot;</span>
    <span class="o">+</span> <span class="n">hkm_returns</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="s2">&quot;moneyness_id&quot;</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">hkm_returns</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">hkm_returns</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">,</span> <span class="s2">&quot;moneyness_id&quot;</span><span class="p">])</span>
    <span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s2">&quot;ftfsa_id&quot;</span><span class="p">,</span> <span class="s2">&quot;date&quot;</span><span class="p">])</span>
    <span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>
<span class="p">)</span>
<span class="c1"># save to data directory</span>
<span class="n">hkm_returns</span><span class="o">.</span><span class="n">to_parquet</span><span class="p">(</span>
    <span class="n">DATA_DIR</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;hkm_portfolio_returns_</span><span class="si">{</span><span class="n">DATE_RANGE</span><span class="si">}</span><span class="s2">.parquet&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="n">hkm_returns</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th>return</th>
    </tr>
    <tr>
      <th>ftfsa_id</th>
      <th>date</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="5" valign="top">hkm_C_1000</th>
      <th>1996-01-31</th>
      <td>-0.004002</td>
    </tr>
    <tr>
      <th>1996-02-29</th>
      <td>-0.000919</td>
    </tr>
    <tr>
      <th>1996-03-31</th>
      <td>-0.000821</td>
    </tr>
    <tr>
      <th>1996-04-30</th>
      <td>0.012018</td>
    </tr>
    <tr>
      <th>1996-05-31</th>
      <td>0.000912</td>
    </tr>
    <tr>
      <th>...</th>
      <th>...</th>
      <td>...</td>
    </tr>
    <tr>
      <th rowspan="5" valign="top">hkm_P_975</th>
      <th>2019-08-31</th>
      <td>0.013859</td>
    </tr>
    <tr>
      <th>2019-09-30</th>
      <td>0.006864</td>
    </tr>
    <tr>
      <th>2019-10-31</th>
      <td>0.050960</td>
    </tr>
    <tr>
      <th>2019-11-30</th>
      <td>0.010639</td>
    </tr>
    <tr>
      <th>2019-12-31</th>
      <td>0.000444</td>
    </tr>
  </tbody>
</table>
<p>5184 rows × 1 columns</p>
</div></div></div>
</div>
</section>
<hr class="docutils" />
<section id="data-discussion">
<h2>Data Discussion<a class="headerlink" href="#data-discussion" title="Link to this heading">#</a></h2>
<p><em><strong>Note:</strong> Code below is for testing and discussion, not final publication.</em></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">test_data</span> <span class="o">=</span> <span class="n">hkm_returns</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="c1"># test_data = cjs_returns.copy()</span>

<span class="n">test_data</span> <span class="o">=</span> <span class="n">test_data</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">pivot_table</span><span class="p">(</span>
    <span class="n">columns</span><span class="o">=</span><span class="s2">&quot;ftfsa_id&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="s2">&quot;date&quot;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="s2">&quot;return&quot;</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<section id="tests-for-normality-of-returns">
<h3>Tests for Normality of Returns<a class="headerlink" href="#tests-for-normality-of-returns" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">returns_df</span> <span class="o">=</span> <span class="n">test_data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<span class="c1"># Apply to returns dataframe</span>
<span class="n">summary_df</span> <span class="o">=</span> <span class="n">normality_summary</span><span class="p">(</span><span class="n">returns_df</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">summary_df</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">na_rep</span><span class="o">=</span><span class="s2">&quot;NaN&quot;</span><span class="p">,</span> <span class="n">precision</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>

<span class="c1"># Plot histogram and QQ plot for each series</span>
<span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">returns_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>

    <span class="n">sns</span><span class="o">.</span><span class="n">histplot</span><span class="p">(</span><span class="n">returns_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">(),</span> <span class="n">kde</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">stat</span><span class="o">=</span><span class="s2">&quot;density&quot;</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Histogram with KDE: </span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">stats</span><span class="o">.</span><span class="n">probplot</span><span class="p">(</span><span class="n">returns_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">(),</span> <span class="n">dist</span><span class="o">=</span><span class="s2">&quot;norm&quot;</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Q-Q Plot: </span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><style type="text/css">
</style>
<table id="T_b71d2">
  <thead>
    <tr>
      <th class="blank level0" >&nbsp;</th>
      <th id="T_b71d2_level0_col0" class="col_heading level0 col0" >Series</th>
      <th id="T_b71d2_level0_col1" class="col_heading level0 col1" >Shapiro_p</th>
      <th id="T_b71d2_level0_col2" class="col_heading level0 col2" >JarqueBera_p</th>
      <th id="T_b71d2_level0_col3" class="col_heading level0 col3" >Normaltest_p</th>
      <th id="T_b71d2_level0_col4" class="col_heading level0 col4" >Skewness</th>
      <th id="T_b71d2_level0_col5" class="col_heading level0 col5" >Kurtosis</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th id="T_b71d2_level0_row0" class="row_heading level0 row0" >0</th>
      <td id="T_b71d2_row0_col0" class="data row0 col0" >hkm_C_1000</td>
      <td id="T_b71d2_row0_col1" class="data row0 col1" >0.00</td>
      <td id="T_b71d2_row0_col2" class="data row0 col2" >0.70</td>
      <td id="T_b71d2_row0_col3" class="data row0 col3" >0.61</td>
      <td id="T_b71d2_row0_col4" class="data row0 col4" >-0.06</td>
      <td id="T_b71d2_row0_col5" class="data row0 col5" >3.21</td>
    </tr>
    <tr>
      <th id="T_b71d2_level0_row1" class="row_heading level0 row1" >1</th>
      <td id="T_b71d2_row1_col0" class="data row1 col0" >hkm_C_1025</td>
      <td id="T_b71d2_row1_col1" class="data row1 col1" >0.00</td>
      <td id="T_b71d2_row1_col2" class="data row1 col2" >0.00</td>
      <td id="T_b71d2_row1_col3" class="data row1 col3" >0.00</td>
      <td id="T_b71d2_row1_col4" class="data row1 col4" >9.84</td>
      <td id="T_b71d2_row1_col5" class="data row1 col5" >129.34</td>
    </tr>
    <tr>
      <th id="T_b71d2_level0_row2" class="row_heading level0 row2" >2</th>
      <td id="T_b71d2_row2_col0" class="data row2 col0" >hkm_C_1050</td>
      <td id="T_b71d2_row2_col1" class="data row2 col1" >0.00</td>
      <td id="T_b71d2_row2_col2" class="data row2 col2" >0.00</td>
      <td id="T_b71d2_row2_col3" class="data row2 col3" >0.00</td>
      <td id="T_b71d2_row2_col4" class="data row2 col4" >4.75</td>
      <td id="T_b71d2_row2_col5" class="data row2 col5" >36.59</td>
    </tr>
    <tr>
      <th id="T_b71d2_level0_row3" class="row_heading level0 row3" >3</th>
      <td id="T_b71d2_row3_col0" class="data row3 col0" >hkm_C_1075</td>
      <td id="T_b71d2_row3_col1" class="data row3 col1" >0.00</td>
      <td id="T_b71d2_row3_col2" class="data row3 col2" >0.00</td>
      <td id="T_b71d2_row3_col3" class="data row3 col3" >0.00</td>
      <td id="T_b71d2_row3_col4" class="data row3 col4" >3.88</td>
      <td id="T_b71d2_row3_col5" class="data row3 col5" >27.00</td>
    </tr>
    <tr>
      <th id="T_b71d2_level0_row4" class="row_heading level0 row4" >4</th>
      <td id="T_b71d2_row4_col0" class="data row4 col0" >hkm_C_1100</td>
      <td id="T_b71d2_row4_col1" class="data row4 col1" >0.00</td>
      <td id="T_b71d2_row4_col2" class="data row4 col2" >0.00</td>
      <td id="T_b71d2_row4_col3" class="data row4 col3" >0.00</td>
      <td id="T_b71d2_row4_col4" class="data row4 col4" >4.44</td>
      <td id="T_b71d2_row4_col5" class="data row4 col5" >30.64</td>
    </tr>
    <tr>
      <th id="T_b71d2_level0_row5" class="row_heading level0 row5" >5</th>
      <td id="T_b71d2_row5_col0" class="data row5 col0" >hkm_C_900</td>
      <td id="T_b71d2_row5_col1" class="data row5 col1" >0.00</td>
      <td id="T_b71d2_row5_col2" class="data row5 col2" >0.00</td>
      <td id="T_b71d2_row5_col3" class="data row5 col3" >0.00</td>
      <td id="T_b71d2_row5_col4" class="data row5 col4" >-0.70</td>
      <td id="T_b71d2_row5_col5" class="data row5 col5" >2.99</td>
    </tr>
    <tr>
      <th id="T_b71d2_level0_row6" class="row_heading level0 row6" >6</th>
      <td id="T_b71d2_row6_col0" class="data row6 col0" >hkm_C_925</td>
      <td id="T_b71d2_row6_col1" class="data row6 col1" >0.00</td>
      <td id="T_b71d2_row6_col2" class="data row6 col2" >0.00</td>
      <td id="T_b71d2_row6_col3" class="data row6 col3" >0.00</td>
      <td id="T_b71d2_row6_col4" class="data row6 col4" >-0.58</td>
      <td id="T_b71d2_row6_col5" class="data row6 col5" >2.34</td>
    </tr>
    <tr>
      <th id="T_b71d2_level0_row7" class="row_heading level0 row7" >7</th>
      <td id="T_b71d2_row7_col0" class="data row7 col0" >hkm_C_950</td>
      <td id="T_b71d2_row7_col1" class="data row7 col1" >0.00</td>
      <td id="T_b71d2_row7_col2" class="data row7 col2" >0.00</td>
      <td id="T_b71d2_row7_col3" class="data row7 col3" >0.00</td>
      <td id="T_b71d2_row7_col4" class="data row7 col4" >-0.51</td>
      <td id="T_b71d2_row7_col5" class="data row7 col5" >2.19</td>
    </tr>
    <tr>
      <th id="T_b71d2_level0_row8" class="row_heading level0 row8" >8</th>
      <td id="T_b71d2_row8_col0" class="data row8 col0" >hkm_C_975</td>
      <td id="T_b71d2_row8_col1" class="data row8 col1" >0.00</td>
      <td id="T_b71d2_row8_col2" class="data row8 col2" >0.22</td>
      <td id="T_b71d2_row8_col3" class="data row8 col3" >0.22</td>
      <td id="T_b71d2_row8_col4" class="data row8 col4" >-0.24</td>
      <td id="T_b71d2_row8_col5" class="data row8 col5" >2.87</td>
    </tr>
    <tr>
      <th id="T_b71d2_level0_row9" class="row_heading level0 row9" >9</th>
      <td id="T_b71d2_row9_col0" class="data row9 col0" >hkm_P_1000</td>
      <td id="T_b71d2_row9_col1" class="data row9 col1" >0.00</td>
      <td id="T_b71d2_row9_col2" class="data row9 col2" >0.00</td>
      <td id="T_b71d2_row9_col3" class="data row9 col3" >0.00</td>
      <td id="T_b71d2_row9_col4" class="data row9 col4" >0.77</td>
      <td id="T_b71d2_row9_col5" class="data row9 col5" >2.84</td>
    </tr>
    <tr>
      <th id="T_b71d2_level0_row10" class="row_heading level0 row10" >10</th>
      <td id="T_b71d2_row10_col0" class="data row10 col0" >hkm_P_1025</td>
      <td id="T_b71d2_row10_col1" class="data row10 col1" >0.00</td>
      <td id="T_b71d2_row10_col2" class="data row10 col2" >0.00</td>
      <td id="T_b71d2_row10_col3" class="data row10 col3" >0.00</td>
      <td id="T_b71d2_row10_col4" class="data row10 col4" >0.79</td>
      <td id="T_b71d2_row10_col5" class="data row10 col5" >2.88</td>
    </tr>
    <tr>
      <th id="T_b71d2_level0_row11" class="row_heading level0 row11" >11</th>
      <td id="T_b71d2_row11_col0" class="data row11 col0" >hkm_P_1050</td>
      <td id="T_b71d2_row11_col1" class="data row11 col1" >0.00</td>
      <td id="T_b71d2_row11_col2" class="data row11 col2" >0.00</td>
      <td id="T_b71d2_row11_col3" class="data row11 col3" >0.00</td>
      <td id="T_b71d2_row11_col4" class="data row11 col4" >0.58</td>
      <td id="T_b71d2_row11_col5" class="data row11 col5" >2.14</td>
    </tr>
    <tr>
      <th id="T_b71d2_level0_row12" class="row_heading level0 row12" >12</th>
      <td id="T_b71d2_row12_col0" class="data row12 col0" >hkm_P_1075</td>
      <td id="T_b71d2_row12_col1" class="data row12 col1" >0.00</td>
      <td id="T_b71d2_row12_col2" class="data row12 col2" >0.00</td>
      <td id="T_b71d2_row12_col3" class="data row12 col3" >0.00</td>
      <td id="T_b71d2_row12_col4" class="data row12 col4" >0.52</td>
      <td id="T_b71d2_row12_col5" class="data row12 col5" >1.84</td>
    </tr>
    <tr>
      <th id="T_b71d2_level0_row13" class="row_heading level0 row13" >13</th>
      <td id="T_b71d2_row13_col0" class="data row13 col0" >hkm_P_1100</td>
      <td id="T_b71d2_row13_col1" class="data row13 col1" >0.00</td>
      <td id="T_b71d2_row13_col2" class="data row13 col2" >0.00</td>
      <td id="T_b71d2_row13_col3" class="data row13 col3" >0.00</td>
      <td id="T_b71d2_row13_col4" class="data row13 col4" >0.61</td>
      <td id="T_b71d2_row13_col5" class="data row13 col5" >1.96</td>
    </tr>
    <tr>
      <th id="T_b71d2_level0_row14" class="row_heading level0 row14" >14</th>
      <td id="T_b71d2_row14_col0" class="data row14 col0" >hkm_P_900</td>
      <td id="T_b71d2_row14_col1" class="data row14 col1" >0.00</td>
      <td id="T_b71d2_row14_col2" class="data row14 col2" >0.00</td>
      <td id="T_b71d2_row14_col3" class="data row14 col3" >0.00</td>
      <td id="T_b71d2_row14_col4" class="data row14 col4" >2.51</td>
      <td id="T_b71d2_row14_col5" class="data row14 col5" >12.87</td>
    </tr>
    <tr>
      <th id="T_b71d2_level0_row15" class="row_heading level0 row15" >15</th>
      <td id="T_b71d2_row15_col0" class="data row15 col0" >hkm_P_925</td>
      <td id="T_b71d2_row15_col1" class="data row15 col1" >0.00</td>
      <td id="T_b71d2_row15_col2" class="data row15 col2" >0.00</td>
      <td id="T_b71d2_row15_col3" class="data row15 col3" >0.00</td>
      <td id="T_b71d2_row15_col4" class="data row15 col4" >3.33</td>
      <td id="T_b71d2_row15_col5" class="data row15 col5" >22.65</td>
    </tr>
    <tr>
      <th id="T_b71d2_level0_row16" class="row_heading level0 row16" >16</th>
      <td id="T_b71d2_row16_col0" class="data row16 col0" >hkm_P_950</td>
      <td id="T_b71d2_row16_col1" class="data row16 col1" >0.00</td>
      <td id="T_b71d2_row16_col2" class="data row16 col2" >0.00</td>
      <td id="T_b71d2_row16_col3" class="data row16 col3" >0.00</td>
      <td id="T_b71d2_row16_col4" class="data row16 col4" >1.82</td>
      <td id="T_b71d2_row16_col5" class="data row16 col5" >8.44</td>
    </tr>
    <tr>
      <th id="T_b71d2_level0_row17" class="row_heading level0 row17" >17</th>
      <td id="T_b71d2_row17_col0" class="data row17 col0" >hkm_P_975</td>
      <td id="T_b71d2_row17_col1" class="data row17 col1" >0.00</td>
      <td id="T_b71d2_row17_col2" class="data row17 col2" >0.00</td>
      <td id="T_b71d2_row17_col3" class="data row17 col3" >0.00</td>
      <td id="T_b71d2_row17_col4" class="data row17 col4" >1.90</td>
      <td id="T_b71d2_row17_col5" class="data row17 col5" >9.19</td>
    </tr>
  </tbody>
</table>
</div><img alt="../_images/e8594fdef10a7576a9211b686f85166bcb5784116076b16f3f23a54e25374147.png" src="../_images/e8594fdef10a7576a9211b686f85166bcb5784116076b16f3f23a54e25374147.png" />
<img alt="../_images/7bbf15a3d663712e305707cb5d941ca4fc2400f50ce082cb1b3aac7df452824e.png" src="../_images/7bbf15a3d663712e305707cb5d941ca4fc2400f50ce082cb1b3aac7df452824e.png" />
<img alt="../_images/7304e4334301a25e543a8d52e6675ffb4a75448d8c7d6ed028fc8b4079fd4402.png" src="../_images/7304e4334301a25e543a8d52e6675ffb4a75448d8c7d6ed028fc8b4079fd4402.png" />
<img alt="../_images/bf7ac8d1103fc74d8e16336c0e18ba1a409268de866d3f05e3a16618750d7db9.png" src="../_images/bf7ac8d1103fc74d8e16336c0e18ba1a409268de866d3f05e3a16618750d7db9.png" />
<img alt="../_images/116231a6ff49e1dfdbe84191c9630136e35197ed3ba48324c4a55260552caea0.png" src="../_images/116231a6ff49e1dfdbe84191c9630136e35197ed3ba48324c4a55260552caea0.png" />
<img alt="../_images/efe24a3e8481221b678d0873842c51b7c7148550db0b94fc494ed75aea4d089b.png" src="../_images/efe24a3e8481221b678d0873842c51b7c7148550db0b94fc494ed75aea4d089b.png" />
<img alt="../_images/a0d59852c5d0778d954dd7e38651345c2a0ed02cc89de26c2580ca6136ffdd3f.png" src="../_images/a0d59852c5d0778d954dd7e38651345c2a0ed02cc89de26c2580ca6136ffdd3f.png" />
<img alt="../_images/f60ed14c544d13e3bb98139b90fbb94e95abdc1adb9d2db366ccff6a8694198f.png" src="../_images/f60ed14c544d13e3bb98139b90fbb94e95abdc1adb9d2db366ccff6a8694198f.png" />
<img alt="../_images/0c0a440e09c2e2dc5f68084b46a660d831c309331fac553cd7172b83e486232b.png" src="../_images/0c0a440e09c2e2dc5f68084b46a660d831c309331fac553cd7172b83e486232b.png" />
<img alt="../_images/55386832ba66c83d3c66db8bc98ca82b1e2b8ba0b395f582eec6f32114a55897.png" src="../_images/55386832ba66c83d3c66db8bc98ca82b1e2b8ba0b395f582eec6f32114a55897.png" />
<img alt="../_images/101075624664135c02d0f8b15a1521bc88fb18663ce6db5d775c3f6e4db2e86c.png" src="../_images/101075624664135c02d0f8b15a1521bc88fb18663ce6db5d775c3f6e4db2e86c.png" />
<img alt="../_images/e86c5d2ceea2167b843e94d72b5705af70c6756090c196097e532fd6b06395db.png" src="../_images/e86c5d2ceea2167b843e94d72b5705af70c6756090c196097e532fd6b06395db.png" />
<img alt="../_images/6326101259da2c2861116a8066c43eff8c1fdade4258956edb39f4eb71c76485.png" src="../_images/6326101259da2c2861116a8066c43eff8c1fdade4258956edb39f4eb71c76485.png" />
<img alt="../_images/9e11d1d6a7bee14c44a0060e98ef8881d1c0e926af8e97d1f6afd134245af609.png" src="../_images/9e11d1d6a7bee14c44a0060e98ef8881d1c0e926af8e97d1f6afd134245af609.png" />
<img alt="../_images/e89455ddfeaf3e3bcff252c78f77cc0e01f4755a4227b4f556b4ee98864873bb.png" src="../_images/e89455ddfeaf3e3bcff252c78f77cc0e01f4755a4227b4f556b4ee98864873bb.png" />
<img alt="../_images/e201792e3ed6f76eabc863c496c13d382bae4d8ba016c9f61e92381f9d7e3ec5.png" src="../_images/e201792e3ed6f76eabc863c496c13d382bae4d8ba016c9f61e92381f9d7e3ec5.png" />
<img alt="../_images/e06f70dc6a9ea8add372d9bc6916b891b52bf4f683b03e53c2f034dd19e8fb60.png" src="../_images/e06f70dc6a9ea8add372d9bc6916b891b52bf4f683b03e53c2f034dd19e8fb60.png" />
<img alt="../_images/3c2721b31287b11d3bcca4e3663afbb01cac349876d3df1a38b81b836aaa855b.png" src="../_images/3c2721b31287b11d3bcca4e3663afbb01cac349876d3df1a38b81b836aaa855b.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># plot groups of portfolios as line charts</span>
<span class="n">portfolio_list</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># [&#39;hkm_C_1000&#39;, &#39;hkm_P_1000&#39;],[&#39;cjs_P_950_30&#39;, &#39;cjs_P_1025_60&#39;, &#39;cjs_C_1000_90&#39;]</span>

<span class="n">chart_data</span> <span class="o">=</span> <span class="n">test_data</span><span class="p">[</span><span class="n">portfolio_list</span><span class="p">]</span> <span class="k">if</span> <span class="n">portfolio_list</span> <span class="k">else</span> <span class="n">test_data</span>

<span class="n">chart_data</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Portfolio Returns Over Time&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Date&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s2">&quot;major&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;#dddddd&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/5759218abc07b378ea0c77de136b44e73c1b3657532fbf0ea7c7978febcdaabf.png" src="../_images/5759218abc07b378ea0c77de136b44e73c1b3657532fbf0ea7c7978febcdaabf.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">metric</span> <span class="o">=</span> <span class="s2">&quot;mean&quot;</span>
<span class="n">chart_data</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;bar&quot;</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">metric</span><span class="si">}</span><span class="s2"> for leverage adj returns&quot;</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s2">&quot;major&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;#dddddd&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/2034477b163bff37375348001ebef4c028b04322fe5bd5533b86ae7acaef47d0.png" src="../_images/2034477b163bff37375348001ebef4c028b04322fe5bd5533b86ae7acaef47d0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">test_data</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">test_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;bar&quot;</span><span class="p">,</span>
    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;lightblue&quot;</span><span class="p">,</span>
    <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span>
    <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Percentage of Missing Returns by Portfolio&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s2">&quot;major&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;#dddddd&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/a4403b54efcf7a96a020215d7ae77720f04d64afef00276a9492b7303fef67e0.png" src="../_images/a4403b54efcf7a96a020215d7ae77720f04d64afef00276a9492b7303fef67e0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">test_data</span><span class="o">.</span><span class="n">skew</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s2">&quot;bar&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Portfolio Returns Skewness&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Portfolio&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">test_data</span><span class="o">.</span><span class="n">columns</span><span class="p">)),</span> <span class="n">test_data</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s2">&quot;major&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;#dddddd&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Skewness&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/cf19be4e776444facccd548b08404bab1fbf1275a1eb2b19aae7ec39ed6f342c.png" src="../_images/cf19be4e776444facccd548b08404bab1fbf1275a1eb2b19aae7ec39ed6f342c.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">test_data</span><span class="o">.</span><span class="n">kurtosis</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s2">&quot;bar&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Portfolio Returns Kurtosis&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Portfolio&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">test_data</span><span class="o">.</span><span class="n">columns</span><span class="p">)),</span> <span class="n">test_data</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s2">&quot;major&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;#dddddd&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Kurtosis&quot;</span><span class="p">)</span>
<span class="c1"># plt.yscale(&#39;log&#39;)  # Log scale for better visibility</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/2d52c56f0da58b369bf81af1d6454fb2f62f4186e35ca889d869c0edf71323bf.png" src="../_images/2d52c56f0da58b369bf81af1d6454fb2f62f4186e35ca889d869c0edf71323bf.png" />
</div>
</div>
</section>
<section id="testing-nan-filling-logic">
<h3>Testing NaN-filling logic<a class="headerlink" href="#testing-nan-filling-logic" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">test</span> <span class="o">=</span> <span class="n">spx_mod</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s2">&quot;date&quot;</span><span class="p">,</span> <span class="s2">&quot;ftfsa_id&quot;</span><span class="p">])</span>
<span class="n">test</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;moneyness&quot;</span><span class="p">,</span> <span class="s2">&quot;days_to_maturity_int&quot;</span><span class="p">,</span> <span class="s2">&quot;kernel_weight&quot;</span><span class="p">,</span> <span class="s2">&quot;exdate&quot;</span><span class="p">]</span>
<span class="n">test</span> <span class="o">=</span> <span class="n">test</span><span class="p">[</span><span class="n">_cols</span> <span class="o">+</span> <span class="p">[</span><span class="n">_</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">test</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">_</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_cols</span><span class="p">]]</span>
<span class="n">test</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th>moneyness</th>
      <th>days_to_maturity_int</th>
      <th>kernel_weight</th>
      <th>exdate</th>
      <th>secid</th>
      <th>open</th>
      <th>close</th>
      <th>cp_flag</th>
      <th>IV</th>
      <th>tb_m3</th>
      <th>...</th>
      <th>log_iv</th>
      <th>fitted_iv</th>
      <th>rel_distance_iv</th>
      <th>moneyness_bin</th>
      <th>stdev_iv_moneyness_bin</th>
      <th>is_outlier_iv</th>
      <th>moneyness_id</th>
      <th>maturity_id</th>
      <th>option_delta</th>
      <th>option_elasticity</th>
    </tr>
    <tr>
      <th>date</th>
      <th>ftfsa_id</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="5" valign="top">1996-01-04</th>
      <th>C_1000_30</th>
      <td>0.987534</td>
      <td>16</td>
      <td>0.412356</td>
      <td>1996-01-20</td>
      <td>108105.0</td>
      <td>621.32</td>
      <td>617.70</td>
      <td>C</td>
      <td>0.082711</td>
      <td>5.04</td>
      <td>...</td>
      <td>-2.492403</td>
      <td>-2.377298</td>
      <td>4.841838</td>
      <td>(0.975, 1.0]</td>
      <td>3.516840</td>
      <td>False</td>
      <td>1.000</td>
      <td>30</td>
      <td>0.805272</td>
      <td>48.826136</td>
    </tr>
    <tr>
      <th>C_1000_30</th>
      <td>0.979440</td>
      <td>44</td>
      <td>0.175289</td>
      <td>1996-02-17</td>
      <td>108105.0</td>
      <td>621.32</td>
      <td>617.70</td>
      <td>C</td>
      <td>0.090735</td>
      <td>5.04</td>
      <td>...</td>
      <td>-2.399812</td>
      <td>-2.443314</td>
      <td>-1.780452</td>
      <td>(0.975, 1.0]</td>
      <td>3.516840</td>
      <td>False</td>
      <td>1.000</td>
      <td>30</td>
      <td>0.807316</td>
      <td>28.094594</td>
    </tr>
    <tr>
      <th>C_1000_30</th>
      <td>0.987534</td>
      <td>44</td>
      <td>0.412356</td>
      <td>1996-02-17</td>
      <td>108105.0</td>
      <td>621.32</td>
      <td>617.70</td>
      <td>C</td>
      <td>0.092040</td>
      <td>5.04</td>
      <td>...</td>
      <td>-2.385532</td>
      <td>-2.394781</td>
      <td>-0.386203</td>
      <td>(0.975, 1.0]</td>
      <td>3.516840</td>
      <td>False</td>
      <td>1.000</td>
      <td>30</td>
      <td>0.725292</td>
      <td>31.717720</td>
    </tr>
    <tr>
      <th>C_1025_30</th>
      <td>1.019913</td>
      <td>16</td>
      <td>1.000000</td>
      <td>1996-01-20</td>
      <td>108105.0</td>
      <td>621.32</td>
      <td>617.70</td>
      <td>C</td>
      <td>0.097356</td>
      <td>5.04</td>
      <td>...</td>
      <td>-2.329381</td>
      <td>-2.285771</td>
      <td>1.907866</td>
      <td>(1.0, 1.025]</td>
      <td>5.219336</td>
      <td>False</td>
      <td>1.025</td>
      <td>30</td>
      <td>0.198018</td>
      <td>95.465702</td>
    </tr>
    <tr>
      <th>C_1050_30</th>
      <td>1.028007</td>
      <td>16</td>
      <td>0.282991</td>
      <td>1996-01-20</td>
      <td>108105.0</td>
      <td>621.32</td>
      <td>617.70</td>
      <td>C</td>
      <td>0.101756</td>
      <td>5.04</td>
      <td>...</td>
      <td>-2.285177</td>
      <td>-2.264082</td>
      <td>0.931727</td>
      <td>(1.025, 1.05]</td>
      <td>4.396845</td>
      <td>False</td>
      <td>1.050</td>
      <td>30</td>
      <td>0.118568</td>
      <td>106.529727</td>
    </tr>
    <tr>
      <th>...</th>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th rowspan="5" valign="top">2019-12-31</th>
      <th>P_975_90</th>
      <td>0.968806</td>
      <td>91</td>
      <td>0.086212</td>
      <td>2020-03-31</td>
      <td>108105.0</td>
      <td>3215.18</td>
      <td>3230.78</td>
      <td>P</td>
      <td>0.154539</td>
      <td>1.52</td>
      <td>...</td>
      <td>-1.867309</td>
      <td>-1.885683</td>
      <td>-0.974399</td>
      <td>(0.95, 0.975]</td>
      <td>2.301503</td>
      <td>False</td>
      <td>0.975</td>
      <td>90</td>
      <td>-0.309106</td>
      <td>-17.880983</td>
    </tr>
    <tr>
      <th>P_975_90</th>
      <td>0.970354</td>
      <td>91</td>
      <td>0.090967</td>
      <td>2020-03-31</td>
      <td>108105.0</td>
      <td>3215.18</td>
      <td>3230.78</td>
      <td>P</td>
      <td>0.153434</td>
      <td>1.52</td>
      <td>...</td>
      <td>-1.874485</td>
      <td>-1.891615</td>
      <td>-0.905577</td>
      <td>(0.95, 0.975]</td>
      <td>2.301503</td>
      <td>False</td>
      <td>0.975</td>
      <td>90</td>
      <td>-0.315405</td>
      <td>-17.877256</td>
    </tr>
    <tr>
      <th>P_975_90</th>
      <td>0.971902</td>
      <td>91</td>
      <td>0.094524</td>
      <td>2020-03-31</td>
      <td>108105.0</td>
      <td>3215.18</td>
      <td>3230.78</td>
      <td>P</td>
      <td>0.152282</td>
      <td>1.52</td>
      <td>...</td>
      <td>-1.882021</td>
      <td>-1.897564</td>
      <td>-0.819094</td>
      <td>(0.95, 0.975]</td>
      <td>2.301503</td>
      <td>False</td>
      <td>0.975</td>
      <td>90</td>
      <td>-0.321794</td>
      <td>-17.878705</td>
    </tr>
    <tr>
      <th>P_975_90</th>
      <td>0.973449</td>
      <td>91</td>
      <td>0.096725</td>
      <td>2020-03-31</td>
      <td>108105.0</td>
      <td>3215.18</td>
      <td>3230.78</td>
      <td>P</td>
      <td>0.151165</td>
      <td>1.52</td>
      <td>...</td>
      <td>-1.889383</td>
      <td>-1.903531</td>
      <td>-0.743212</td>
      <td>(0.95, 0.975]</td>
      <td>2.301503</td>
      <td>False</td>
      <td>0.975</td>
      <td>90</td>
      <td>-0.328353</td>
      <td>-17.874229</td>
    </tr>
    <tr>
      <th>P_975_90</th>
      <td>0.974997</td>
      <td>91</td>
      <td>0.097473</td>
      <td>2020-03-31</td>
      <td>108105.0</td>
      <td>3215.18</td>
      <td>3230.78</td>
      <td>P</td>
      <td>0.150000</td>
      <td>1.52</td>
      <td>...</td>
      <td>-1.897120</td>
      <td>-1.909514</td>
      <td>-0.649088</td>
      <td>(0.95, 0.975]</td>
      <td>2.301503</td>
      <td>False</td>
      <td>0.975</td>
      <td>90</td>
      <td>-0.335009</td>
      <td>-17.875128</td>
    </tr>
  </tbody>
</table>
<p>1926214 rows × 30 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">daily_returns</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>ftfsa_id</th>
      <th>C_1000_30</th>
      <th>C_1000_60</th>
      <th>C_1000_90</th>
      <th>C_1025_30</th>
      <th>C_1025_60</th>
      <th>C_1025_90</th>
      <th>C_1050_30</th>
      <th>C_1050_60</th>
      <th>C_1050_90</th>
      <th>C_1075_30</th>
      <th>...</th>
      <th>P_900_90</th>
      <th>P_925_30</th>
      <th>P_925_60</th>
      <th>P_925_90</th>
      <th>P_950_30</th>
      <th>P_950_60</th>
      <th>P_950_90</th>
      <th>P_975_30</th>
      <th>P_975_60</th>
      <th>P_975_90</th>
    </tr>
    <tr>
      <th>date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1996-01-04</th>
      <td>0.002171</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.000198</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>-0.003106</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.003393</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1996-01-05</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>-0.002985</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.004674</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1996-01-09</th>
      <td>-0.004362</td>
      <td>-0.005736</td>
      <td>NaN</td>
      <td>0.011077</td>
      <td>0.000193</td>
      <td>NaN</td>
      <td>0.039018</td>
      <td>0.000195</td>
      <td>NaN</td>
      <td>0.008154</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.000191</td>
      <td>NaN</td>
      <td>0.011241</td>
      <td>0.007766</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1996-01-10</th>
      <td>-0.001291</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>-0.003064</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>-0.005087</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1996-01-22</th>
      <td>-0.002792</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>-0.004186</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.004054</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.016734</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>2019-12-24</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>-0.001959</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>0.000877</td>
      <td>NaN</td>
      <td>0.000702</td>
      <td>-0.003096</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.007690</td>
      <td>-0.007144</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2019-12-26</th>
      <td>0.000177</td>
      <td>-0.000588</td>
      <td>-0.001565</td>
      <td>0.049612</td>
      <td>0.000451</td>
      <td>-0.001096</td>
      <td>0.001201</td>
      <td>0.000729</td>
      <td>NaN</td>
      <td>0.001499</td>
      <td>...</td>
      <td>0.000925</td>
      <td>0.000619</td>
      <td>0.000816</td>
      <td>0.001072</td>
      <td>0.000456</td>
      <td>0.000826</td>
      <td>0.000696</td>
      <td>0.002388</td>
      <td>0.000837</td>
      <td>0.000776</td>
    </tr>
    <tr>
      <th>2019-12-27</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>0.001085</td>
      <td>NaN</td>
      <td>0.000463</td>
      <td>0.002847</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.002921</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2019-12-30</th>
      <td>0.000195</td>
      <td>-0.000363</td>
      <td>-0.000944</td>
      <td>0.000539</td>
      <td>0.000115</td>
      <td>-0.001000</td>
      <td>0.001502</td>
      <td>-0.000179</td>
      <td>-0.001638</td>
      <td>0.000554</td>
      <td>...</td>
      <td>0.001061</td>
      <td>0.000485</td>
      <td>0.000862</td>
      <td>0.000741</td>
      <td>0.000373</td>
      <td>0.000779</td>
      <td>0.000816</td>
      <td>0.000222</td>
      <td>0.000845</td>
      <td>0.001032</td>
    </tr>
    <tr>
      <th>2019-12-31</th>
      <td>0.000164</td>
      <td>-0.000746</td>
      <td>-0.001073</td>
      <td>0.000216</td>
      <td>-0.000542</td>
      <td>-0.001064</td>
      <td>0.000767</td>
      <td>-0.000273</td>
      <td>-0.000936</td>
      <td>0.000142</td>
      <td>...</td>
      <td>0.000913</td>
      <td>0.000537</td>
      <td>0.000821</td>
      <td>0.000914</td>
      <td>0.000592</td>
      <td>0.000825</td>
      <td>0.000898</td>
      <td>0.000382</td>
      <td>0.000766</td>
      <td>0.000936</td>
    </tr>
  </tbody>
</table>
<p>3740 rows × 54 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">test</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">IndexSlice</span><span class="p">[</span><span class="s2">&quot;1996-01-04&quot;</span><span class="p">:</span><span class="s2">&quot;1996-01-10&quot;</span><span class="p">,</span> <span class="s2">&quot;C_1000_30&quot;</span><span class="p">],</span> <span class="p">:]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th>moneyness</th>
      <th>days_to_maturity_int</th>
      <th>kernel_weight</th>
      <th>exdate</th>
      <th>secid</th>
      <th>open</th>
      <th>close</th>
      <th>cp_flag</th>
      <th>IV</th>
      <th>tb_m3</th>
      <th>...</th>
      <th>log_iv</th>
      <th>fitted_iv</th>
      <th>rel_distance_iv</th>
      <th>moneyness_bin</th>
      <th>stdev_iv_moneyness_bin</th>
      <th>is_outlier_iv</th>
      <th>moneyness_id</th>
      <th>maturity_id</th>
      <th>option_delta</th>
      <th>option_elasticity</th>
    </tr>
    <tr>
      <th>date</th>
      <th>ftfsa_id</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="3" valign="top">1996-01-04</th>
      <th>C_1000_30</th>
      <td>0.987534</td>
      <td>16</td>
      <td>0.412356</td>
      <td>1996-01-20</td>
      <td>108105.0</td>
      <td>621.32</td>
      <td>617.70</td>
      <td>C</td>
      <td>0.082711</td>
      <td>5.04</td>
      <td>...</td>
      <td>-2.492403</td>
      <td>-2.377298</td>
      <td>4.841838</td>
      <td>(0.975, 1.0]</td>
      <td>3.51684</td>
      <td>False</td>
      <td>1.0</td>
      <td>30</td>
      <td>0.805272</td>
      <td>48.826136</td>
    </tr>
    <tr>
      <th>C_1000_30</th>
      <td>0.979440</td>
      <td>44</td>
      <td>0.175289</td>
      <td>1996-02-17</td>
      <td>108105.0</td>
      <td>621.32</td>
      <td>617.70</td>
      <td>C</td>
      <td>0.090735</td>
      <td>5.04</td>
      <td>...</td>
      <td>-2.399812</td>
      <td>-2.443314</td>
      <td>-1.780452</td>
      <td>(0.975, 1.0]</td>
      <td>3.51684</td>
      <td>False</td>
      <td>1.0</td>
      <td>30</td>
      <td>0.807316</td>
      <td>28.094594</td>
    </tr>
    <tr>
      <th>C_1000_30</th>
      <td>0.987534</td>
      <td>44</td>
      <td>0.412356</td>
      <td>1996-02-17</td>
      <td>108105.0</td>
      <td>621.32</td>
      <td>617.70</td>
      <td>C</td>
      <td>0.092040</td>
      <td>5.04</td>
      <td>...</td>
      <td>-2.385532</td>
      <td>-2.394781</td>
      <td>-0.386203</td>
      <td>(0.975, 1.0]</td>
      <td>3.51684</td>
      <td>False</td>
      <td>1.0</td>
      <td>30</td>
      <td>0.725292</td>
      <td>31.717720</td>
    </tr>
    <tr>
      <th rowspan="3" valign="top">1996-01-09</th>
      <th>C_1000_30</th>
      <td>0.976290</td>
      <td>39</td>
      <td>0.112423</td>
      <td>1996-02-17</td>
      <td>108105.0</td>
      <td>618.46</td>
      <td>609.45</td>
      <td>C</td>
      <td>0.097121</td>
      <td>5.01</td>
      <td>...</td>
      <td>-2.331798</td>
      <td>-2.388494</td>
      <td>-2.373727</td>
      <td>(0.975, 1.0]</td>
      <td>3.51684</td>
      <td>False</td>
      <td>1.0</td>
      <td>30</td>
      <td>0.826477</td>
      <td>28.578530</td>
    </tr>
    <tr>
      <th>C_1000_30</th>
      <td>0.984494</td>
      <td>39</td>
      <td>0.314758</td>
      <td>1996-02-17</td>
      <td>108105.0</td>
      <td>618.46</td>
      <td>609.45</td>
      <td>C</td>
      <td>0.100478</td>
      <td>5.01</td>
      <td>...</td>
      <td>-2.297816</td>
      <td>-2.340017</td>
      <td>-1.803411</td>
      <td>(0.975, 1.0]</td>
      <td>3.51684</td>
      <td>False</td>
      <td>1.0</td>
      <td>30</td>
      <td>0.743834</td>
      <td>32.094128</td>
    </tr>
    <tr>
      <th>C_1000_30</th>
      <td>0.992698</td>
      <td>39</td>
      <td>0.572820</td>
      <td>1996-02-17</td>
      <td>108105.0</td>
      <td>618.46</td>
      <td>609.45</td>
      <td>C</td>
      <td>0.100392</td>
      <td>5.01</td>
      <td>...</td>
      <td>-2.298673</td>
      <td>-2.297086</td>
      <td>0.069066</td>
      <td>(0.975, 1.0]</td>
      <td>3.51684</td>
      <td>False</td>
      <td>1.0</td>
      <td>30</td>
      <td>0.656472</td>
      <td>36.789613</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">1996-01-10</th>
      <th>C_1000_30</th>
      <td>0.977476</td>
      <td>10</td>
      <td>0.272701</td>
      <td>1996-01-20</td>
      <td>108105.0</td>
      <td>609.45</td>
      <td>598.48</td>
      <td>C</td>
      <td>0.136584</td>
      <td>5.04</td>
      <td>...</td>
      <td>-1.990815</td>
      <td>-1.917546</td>
      <td>3.820998</td>
      <td>(0.975, 1.0]</td>
      <td>3.51684</td>
      <td>False</td>
      <td>1.0</td>
      <td>30</td>
      <td>0.859944</td>
      <td>34.027042</td>
    </tr>
    <tr>
      <th>C_1000_30</th>
      <td>0.985831</td>
      <td>10</td>
      <td>0.727299</td>
      <td>1996-01-20</td>
      <td>108105.0</td>
      <td>609.45</td>
      <td>598.48</td>
      <td>C</td>
      <td>0.148282</td>
      <td>5.04</td>
      <td>...</td>
      <td>-1.908639</td>
      <td>-1.958191</td>
      <td>-2.530474</td>
      <td>(0.975, 1.0]</td>
      <td>3.51684</td>
      <td>False</td>
      <td>1.0</td>
      <td>30</td>
      <td>0.742142</td>
      <td>39.046794</td>
    </tr>
  </tbody>
</table>
<p>8 rows × 30 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">test</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">IndexSlice</span><span class="p">[</span><span class="s2">&quot;1996-01-04&quot;</span><span class="p">:</span><span class="s2">&quot;1996-01-10&quot;</span><span class="p">,</span> <span class="s2">&quot;C_1025_30&quot;</span><span class="p">],</span> <span class="p">:]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th>moneyness</th>
      <th>days_to_maturity_int</th>
      <th>kernel_weight</th>
      <th>exdate</th>
      <th>secid</th>
      <th>open</th>
      <th>close</th>
      <th>cp_flag</th>
      <th>IV</th>
      <th>tb_m3</th>
      <th>...</th>
      <th>log_iv</th>
      <th>fitted_iv</th>
      <th>rel_distance_iv</th>
      <th>moneyness_bin</th>
      <th>stdev_iv_moneyness_bin</th>
      <th>is_outlier_iv</th>
      <th>moneyness_id</th>
      <th>maturity_id</th>
      <th>option_delta</th>
      <th>option_elasticity</th>
    </tr>
    <tr>
      <th>date</th>
      <th>ftfsa_id</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1996-01-04</th>
      <th>C_1025_30</th>
      <td>1.019913</td>
      <td>16</td>
      <td>1.000000</td>
      <td>1996-01-20</td>
      <td>108105.0</td>
      <td>621.32</td>
      <td>617.70</td>
      <td>C</td>
      <td>0.097356</td>
      <td>5.04</td>
      <td>...</td>
      <td>-2.329381</td>
      <td>-2.285771</td>
      <td>1.907866</td>
      <td>(1.0, 1.025]</td>
      <td>5.219336</td>
      <td>False</td>
      <td>1.025</td>
      <td>30</td>
      <td>0.198018</td>
      <td>95.465702</td>
    </tr>
    <tr>
      <th>1996-01-05</th>
      <th>C_1025_30</th>
      <td>1.021550</td>
      <td>15</td>
      <td>1.000000</td>
      <td>1996-01-20</td>
      <td>108105.0</td>
      <td>617.70</td>
      <td>616.71</td>
      <td>C</td>
      <td>0.091355</td>
      <td>5.03</td>
      <td>...</td>
      <td>-2.393002</td>
      <td>-2.383062</td>
      <td>0.417130</td>
      <td>(1.0, 1.025]</td>
      <td>5.219336</td>
      <td>False</td>
      <td>1.025</td>
      <td>30</td>
      <td>0.151415</td>
      <td>114.927948</td>
    </tr>
    <tr>
      <th rowspan="5" valign="top">1996-01-09</th>
      <th>C_1025_30</th>
      <td>1.000902</td>
      <td>11</td>
      <td>0.023004</td>
      <td>1996-01-20</td>
      <td>108105.0</td>
      <td>618.46</td>
      <td>609.45</td>
      <td>C</td>
      <td>0.091177</td>
      <td>5.01</td>
      <td>...</td>
      <td>-2.394953</td>
      <td>-2.364593</td>
      <td>1.283913</td>
      <td>(1.0, 1.025]</td>
      <td>5.219336</td>
      <td>False</td>
      <td>1.025</td>
      <td>30</td>
      <td>0.518470</td>
      <td>81.543671</td>
    </tr>
    <tr>
      <th>C_1025_30</th>
      <td>1.017311</td>
      <td>11</td>
      <td>0.122083</td>
      <td>1996-01-20</td>
      <td>108105.0</td>
      <td>618.46</td>
      <td>609.45</td>
      <td>C</td>
      <td>0.099723</td>
      <td>5.01</td>
      <td>...</td>
      <td>-2.305359</td>
      <td>-2.368567</td>
      <td>-2.668626</td>
      <td>(1.0, 1.025]</td>
      <td>5.219336</td>
      <td>False</td>
      <td>1.025</td>
      <td>30</td>
      <td>0.185260</td>
      <td>120.433497</td>
    </tr>
    <tr>
      <th>C_1025_30</th>
      <td>1.000902</td>
      <td>39</td>
      <td>0.093288</td>
      <td>1996-02-17</td>
      <td>108105.0</td>
      <td>618.46</td>
      <td>609.45</td>
      <td>C</td>
      <td>0.092492</td>
      <td>5.01</td>
      <td>...</td>
      <td>-2.380633</td>
      <td>-2.259703</td>
      <td>5.351598</td>
      <td>(1.0, 1.025]</td>
      <td>5.219336</td>
      <td>False</td>
      <td>1.025</td>
      <td>30</td>
      <td>0.564481</td>
      <td>45.869738</td>
    </tr>
    <tr>
      <th>C_1025_30</th>
      <td>1.009107</td>
      <td>39</td>
      <td>0.266554</td>
      <td>1996-02-17</td>
      <td>108105.0</td>
      <td>618.46</td>
      <td>609.45</td>
      <td>C</td>
      <td>0.120972</td>
      <td>5.01</td>
      <td>...</td>
      <td>-2.112196</td>
      <td>-2.227867</td>
      <td>-5.191982</td>
      <td>(1.0, 1.025]</td>
      <td>5.219336</td>
      <td>False</td>
      <td>1.025</td>
      <td>30</td>
      <td>0.470463</td>
      <td>38.551087</td>
    </tr>
    <tr>
      <th>C_1025_30</th>
      <td>1.017311</td>
      <td>39</td>
      <td>0.495071</td>
      <td>1996-02-17</td>
      <td>108105.0</td>
      <td>618.46</td>
      <td>609.45</td>
      <td>C</td>
      <td>0.111577</td>
      <td>5.01</td>
      <td>...</td>
      <td>-2.193040</td>
      <td>-2.201577</td>
      <td>-0.387767</td>
      <td>(1.0, 1.025]</td>
      <td>5.219336</td>
      <td>False</td>
      <td>1.025</td>
      <td>30</td>
      <td>0.379971</td>
      <td>47.502205</td>
    </tr>
  </tbody>
</table>
<p>7 rows × 30 columns</p>
</div></div></div>
</div>
</section>
</section>
</section>


                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="combined_filters.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">OptionsFilters Summary</p>
      </div>
    </a>
    <a class="right-next"
       href="../spx_options_description.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">He, Kelly, Manela (HKM) Test Portfolios: Options</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <dialog id="pst-secondary-sidebar-modal"></dialog>
                <div id="pst-secondary-sidebar" class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#imports">Imports</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#functions">Functions</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#execution">Execution</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#construction-of-monthly-leverage-adjusted-portfolio-returns-in-cjs">Construction of Monthly Leverage-Adjusted Portfolio Returns in CJS</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#mathematical-details-of-portfolio-construction">Mathematical Details of Portfolio Construction</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#gaussian-kernel-weighting">1. Gaussian Kernel Weighting</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#option-elasticity">2. Option Elasticity</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#arithmetic-return-of-option-i">3. Arithmetic Return of Option <span class="math notranslate nohighlight">\(i\)</span></a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#leverage-adjusted-portfolio-construction">4. Leverage-Adjusted Portfolio Construction</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#implementation">Implementation</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#build-the-ftsfa-id-for-each-portfolio">1. Build the FTSFA ID for each portfolio</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#calculate-option-elasticity-and-daily-kernel-weighting-for-candidate-options-for-each-portfolio">2. Calculate option elasticity and daily kernel weighting for candidate options for each portfolio.</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#remove-options-from-the-portfolio-with-weights-lower-than-1">3. Remove options from the portfolio with weights lower than 1%</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#calculate-the-daily-arithmetic-return-and-the-leverage-adjusted-return-of-each-portfolio">4. Calculate the daily arithmetic return and the leverage-adjusted return of each portfolio.</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#to-be-implemented-filling-nans">5. (to be implemented) Filling NaNs</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#compound-daily-portfolio-returns-to-monthly-final-54-portfolios-in-cjs">6. Compound Daily Portfolio Returns to Monthly (final 54 portfolios in CJS)</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#construction-of-18-portfolio-return-series-in-he-kelly-manela-hkm-2017">Construction of 18 Portfolio Return Series in He, Kelly, Manela (HKM 2017)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#data-discussion">Data Discussion</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#tests-for-normality-of-returns">Tests for Normality of Returns</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#testing-nan-filling-logic">Testing NaN-filling logic</a></li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Jeremiah Bejarano
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2024, Jeremiah Bejarano.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf"></script>
<script defer src="../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>